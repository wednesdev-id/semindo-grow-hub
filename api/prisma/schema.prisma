// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ============================================
// USER MANAGEMENT & RBAC
// ============================================

model User {
  id            String   @id @default(uuid())
  email         String   @unique
  passwordHash  String   @map("password_hash")
  fullName      String   @map("full_name")
  phone         String?
  businessName  String?  @map("business_name")
  emailVerified Boolean  @default(false) @map("email_verified")
  isActive      Boolean  @default(true) @map("is_active")
  createdAt     DateTime @default(now()) @map("created_at")
  updatedAt     DateTime @updatedAt @map("updated_at")

  // Relations
  userRoles    UserRole[]
  assessments  Assessment[]
  umkmProfile  UMKMProfile?
  mentorProfile MentorProfile?
  auditLogs    AuditLog[]
  authoredCourses Course[]
  enrollments  Enrollment[]
  products     Product[]
  orders       Order[]

  @@map("users")
}

model Role {
  id          String   @id @default(uuid())
  name        String   @unique
  displayName String   @map("display_name")
  description String?
  createdAt   DateTime @default(now()) @map("created_at")

  // Relations
  userRoles       UserRole[]
  rolePermissions RolePermission[]

  @@map("roles")
}

model Permission {
  id          String   @id @default(uuid())
  name        String   @unique
  displayName String   @map("display_name")
  description String?
  createdAt   DateTime @default(now()) @map("created_at")

  // Relations
  rolePermissions RolePermission[]

  @@map("permissions")
}

model UserRole {
  userId     String   @map("user_id")
  roleId     String   @map("role_id")
  assignedAt DateTime @default(now()) @map("assigned_at")

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)
  role Role @relation(fields: [roleId], references: [id], onDelete: Cascade)

  @@id([userId, roleId])
  @@map("user_roles")
}

model RolePermission {
  roleId       String @map("role_id")
  permissionId String @map("permission_id")

  role       Role       @relation(fields: [roleId], references: [id], onDelete: Cascade)
  permission Permission @relation(fields: [permissionId], references: [id], onDelete: Cascade)

  @@id([roleId, permissionId])
  @@map("role_permissions")
}

// ============================================
// ASSESSMENT SYSTEM
// ============================================

model Assessment {
  id          String    @id @default(uuid())
  userId      String    @map("user_id")
  templateId  String?   @map("template_id")
  status      String    @default("draft") // draft, in_progress, completed
  startedAt   DateTime? @map("started_at")
  completedAt DateTime? @map("completed_at")
  createdAt   DateTime  @default(now()) @map("created_at")
  updatedAt   DateTime  @updatedAt @map("updated_at")

  // Relations
  user      User                 @relation(fields: [userId], references: [id], onDelete: Cascade)
  template  AssessmentTemplate?  @relation(fields: [templateId], references: [id])
  responses AssessmentResponse[]
  score     AssessmentScore?
  recommendations AssessmentRecommendation[]

  @@map("assessments")
}

model AssessmentTemplate {
  id          String   @id @default(uuid())
  title       String
  description String?
  category    String   // e.g., "General", "F&B", "Retail"
  isActive    Boolean  @default(true) @map("is_active")
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")

  questions   AssessmentQuestion[]
  assessments Assessment[]
  recommendationRules RecommendationRule[]

  @@map("assessment_templates")
}

model AssessmentCategory {
  id          String   @id @default(uuid())
  name        String
  description String?
  weight      Decimal  @default(1.0) @db.Decimal(3, 2)
  
  questions   AssessmentQuestion[]
  recommendationRules RecommendationRule[]

  @@map("assessment_categories")
}

model AssessmentQuestion {
  id          String   @id @default(uuid())
  templateId  String   @map("template_id")
  categoryId  String   @map("category_id")
  text        String
  type        String   // multiple_choice, scale, boolean, text
  options     Json?    // For multiple choice
  weight      Decimal  @default(1.0) @db.Decimal(3, 2)
  order       Int      @default(0)
  
  template    AssessmentTemplate @relation(fields: [templateId], references: [id])
  category    AssessmentCategory @relation(fields: [categoryId], references: [id])
  responses   AssessmentResponse[]
  
  @@map("assessment_questions")
}

model AssessmentResponse {
  id           String   @id @default(uuid())
  assessmentId String   @map("assessment_id")
  questionId   String   @map("question_id")
  answerValue  Json     @map("answer_value")
  createdAt    DateTime @default(now()) @map("created_at")

  assessment Assessment         @relation(fields: [assessmentId], references: [id], onDelete: Cascade)
  question   AssessmentQuestion @relation(fields: [questionId], references: [id])

  @@unique([assessmentId, questionId])
  @@map("assessment_responses")
}

model AssessmentScore {
  id              String   @id @default(uuid())
  assessmentId    String   @unique @map("assessment_id")
  totalScore      Decimal  @map("total_score") @db.Decimal(5, 2)
  umkmLevel       String   @map("umkm_level") // mikro, kecil, menengah
  confidenceScore Decimal? @map("confidence_score") @db.Decimal(3, 2)
  categoryScores  Json     @map("category_scores")
  calculatedAt    DateTime @default(now()) @map("calculated_at")

  assessment Assessment @relation(fields: [assessmentId], references: [id], onDelete: Cascade)

  @@map("assessment_scores")
}

model RecommendationRule {
  id          String   @id @default(uuid())
  templateId  String   @map("template_id")
  categoryId  String?  @map("category_id")
  
  // Condition
  minScore    Decimal? @db.Decimal(5, 2)
  maxScore    Decimal? @db.Decimal(5, 2)
  
  // Output
  title       String
  description String
  priority    String   // high, medium, low
  actionItems Json     // Array of strings
  resources   Json?    // Array of { title, type, url }
  
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")

  template    AssessmentTemplate @relation(fields: [templateId], references: [id])
  category    AssessmentCategory? @relation(fields: [categoryId], references: [id])

  @@map("recommendation_rules")
}

model AssessmentRecommendation {
  id           String   @id @default(uuid())
  assessmentId String   @map("assessment_id")
  
  title        String
  description  String
  priority     String
  category     String
  actionItems  Json
  resources    Json?
  
  createdAt    DateTime @default(now()) @map("created_at")

  assessment   Assessment @relation(fields: [assessmentId], references: [id], onDelete: Cascade)

  @@map("assessment_recommendations")
}

// ============================================
// PROFILES & DOCUMENTS
// ============================================

model UMKMProfile {
  id          String   @id @default(uuid())
  userId      String   @unique @map("user_id")
  
  // Business Details
  businessName String  @map("business_name")
  ownerName    String  @map("owner_name")
  address      String?
  city         String?
  province     String?
  postalCode   String? @map("postal_code")
  phone        String?
  email        String?
  website      String?
  
  // Business Metrics
  sector       String? // Kuliner, Fashion, etc.
  turnover     Decimal? @db.Decimal(15, 2) // Omzet per tahun
  assets       Decimal? @db.Decimal(15, 2) // Total aset
  employees    Int?
  foundedYear  Int?    @map("founded_year")
  
  // Status
  level        String? // Mikro, Kecil, Menengah (Calculated)
  isVerified   Boolean @default(false) @map("is_verified")
  
  createdAt    DateTime @default(now()) @map("created_at")
  updatedAt    DateTime @updatedAt @map("updated_at")

  // Relations
  user      User       @relation(fields: [userId], references: [id], onDelete: Cascade)
  documents Document[]

  @@map("umkm_profiles")
}

model MentorProfile {
  id          String   @id @default(uuid())
  userId      String   @unique @map("user_id")
  
  title       String?  // e.g., "Senior Business Consultant"
  bio         String?  @db.Text
  expertise   String[] // Array of strings: ["Marketing", "Finance"]
  experience  Int?     // Years of experience
  linkedIn    String?  @map("linkedin_url")
  
  isVerified  Boolean  @default(false) @map("is_verified")
  rating      Decimal  @default(0) @db.Decimal(3, 2)
  
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")

  // Relations
  user      User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("mentor_profiles")
}

model Document {
  id            String   @id @default(uuid())
  umkmProfileId String?  @map("umkm_profile_id")
  
  type          String   // NIB, NPWP, KTP, SKU, Other
  number        String?  // Document number
  fileUrl       String   @map("file_url")
  fileName      String   @map("file_name")
  fileSize      Int?     @map("file_size")
  mimeType      String?  @map("mime_type")
  
  status        String   @default("pending") // pending, verified, rejected
  verifiedAt    DateTime? @map("verified_at")
  verifiedBy    String?   @map("verified_by")
  rejectionReason String? @map("rejection_reason")
  
  createdAt     DateTime @default(now()) @map("created_at")
  updatedAt     DateTime @updatedAt @map("updated_at")

  // Relations
  umkmProfile UMKMProfile? @relation(fields: [umkmProfileId], references: [id], onDelete: Cascade)

  @@map("documents")
}

// ============================================
// SYSTEM & LOGS
// ============================================

model AuditLog {
  id          String   @id @default(uuid())
  userId      String?  @map("user_id")
  
  action      String   // LOGIN, CREATE, UPDATE, DELETE
  resource    String   // users, assessments, etc.
  resourceId  String?  @map("resource_id")
  
  oldValue    Json?    @map("old_value")
  newValue    Json?    @map("new_value")
  
  ipAddress   String?  @map("ip_address")
  userAgent   String?  @map("user_agent")
  
  createdAt   DateTime @default(now()) @map("created_at")

  // Relations
  user        User?    @relation(fields: [userId], references: [id], onDelete: SetNull)

  @@index([userId])
  @@index([resource, resourceId])
  @@map("audit_logs")
}

// ============================================
// LEARNING HUB (LMS)
// ============================================

model Course {
  id           String   @id @default(uuid())
  title        String
  slug         String   @unique
  description  String?  @db.Text
  thumbnailUrl String?  @map("thumbnail_url")
  level        String   @default("beginner") // beginner, intermediate, advanced
  category     String
  price        Decimal  @default(0) @db.Decimal(10, 2)
  isPublished  Boolean  @default(false) @map("is_published")
  authorId     String   @map("author_id")
  
  createdAt    DateTime @default(now()) @map("created_at")
  updatedAt    DateTime @updatedAt @map("updated_at")

  // Relations
  author      User         @relation(fields: [authorId], references: [id])
  modules     Module[]
  enrollments Enrollment[]

  @@map("courses")
}

model Module {
  id        String   @id @default(uuid())
  courseId  String   @map("course_id")
  title     String
  order     Int      @default(0)
  
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  // Relations
  course  Course   @relation(fields: [courseId], references: [id], onDelete: Cascade)
  lessons Lesson[]

  @@map("modules")
}

model Lesson {
  id        String   @id @default(uuid())
  moduleId  String   @map("module_id")
  title     String
  slug      String   @unique
  type      String   @default("video") // video, article, quiz
  content   String?  @db.Text // For articles
  videoUrl  String?  @map("video_url")
  duration  Int      @default(0) // in minutes
  order     Int      @default(0)
  isFree    Boolean  @default(false) @map("is_free") // Preview allowed
  
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  // Relations
  module   Module           @relation(fields: [moduleId], references: [id], onDelete: Cascade)
  progress LessonProgress[]

  @@map("lessons")
}

model Enrollment {
  id          String    @id @default(uuid())
  userId      String    @map("user_id")
  courseId    String    @map("course_id")
  status      String    @default("active") // active, completed, dropped
  progress    Int       @default(0) // 0-100
  enrolledAt  DateTime  @default(now()) @map("enrolled_at")
  completedAt DateTime? @map("completed_at")

  // Relations
  user     User             @relation(fields: [userId], references: [id], onDelete: Cascade)
  course   Course           @relation(fields: [courseId], references: [id], onDelete: Cascade)
  lessonProgress LessonProgress[]

  @@unique([userId, courseId])
  @@map("enrollments")
}

model LessonProgress {
  id           String    @id @default(uuid())
  enrollmentId String    @map("enrollment_id")
  lessonId     String    @map("lesson_id")
  isCompleted  Boolean   @default(false) @map("is_completed")
  completedAt  DateTime? @map("completed_at")
  lastWatched  Int       @default(0) @map("last_watched") // timestamp in seconds

  // Relations
  enrollment Enrollment @relation(fields: [enrollmentId], references: [id], onDelete: Cascade)
  lesson     Lesson     @relation(fields: [lessonId], references: [id], onDelete: Cascade)

  @@unique([enrollmentId, lessonId])
  @@map("lesson_progress")
}

// ============================================
// MARKETPLACE
// ============================================

model Product {
  id          String   @id @default(uuid())
  title       String
  slug        String   @unique
  description String?  @db.Text
  price       Decimal  @default(0) @db.Decimal(10, 2)
  stock       Int      @default(0)
  category    String
  images      Json?    // Array of strings (URLs)
  sellerId    String   @map("seller_id")
  
  isPublished Boolean  @default(false) @map("is_published")
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")

  // Relations
  seller      User     @relation(fields: [sellerId], references: [id])
  orderItems  OrderItem[]

  @@map("products")
}

model Order {
  id          String   @id @default(uuid())
  userId      String   @map("user_id")
  status      String   @default("pending") // pending, paid, shipped, completed, cancelled
  totalAmount Decimal  @map("total_amount") @db.Decimal(10, 2)
  
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")

  // Relations
  user        User        @relation(fields: [userId], references: [id])
  items       OrderItem[]

  @@map("orders")
}

model OrderItem {
  id        String   @id @default(uuid())
  orderId   String   @map("order_id")
  productId String   @map("product_id")
  quantity  Int      @default(1)
  price     Decimal  @db.Decimal(10, 2) // Price at the time of purchase
  
  // Relations
  order     Order    @relation(fields: [orderId], references: [id], onDelete: Cascade)
  product   Product  @relation(fields: [productId], references: [id])

  @@map("order_items")
}
