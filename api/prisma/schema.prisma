// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ============================================
// USER MANAGEMENT & RBAC
// ============================================

model User {
  id                String   @id @default(uuid())
  email             String   @unique
  passwordHash      String   @map("password_hash")
  fullName          String   @map("full_name")
  phone             String?
  businessName      String?  @map("business_name")
  profilePictureUrl String?  @map("profile_picture_url")
  emailVerified     Boolean  @default(false) @map("email_verified")
  isActive          Boolean  @default(true) @map("is_active")
  createdAt         DateTime @default(now()) @map("created_at")
  updatedAt         DateTime @updatedAt @map("updated_at")

  // Relations
  userRoles        UserRole[]
  assessments      Assessment[]
  umkmProfile      UMKMProfile?
  mentorProfile    MentorProfile?
  auditLogs        AuditLog[]
  authoredCourses  Course[]
  enrollments      Enrollment[]
  products         Product[]
  orders           Order[]
  loanApplications LoanApplication[]

  // Marketplace Relations
  store   Store?
  cart    Cart?
  reviews Review[]

  // Community Relations
  forumThreads       ForumThread[]
  forumPosts         ForumPost[]
  forumUpvotes       ForumUpvote[]
  organizedEvents    Event[]
  eventRegistrations EventRegistration[]

  // Program Relations
  organizedPrograms     Program[]
  programParticipations ProgramParticipant[]
  quizAttempts          QuizAttempt[]
  assignmentSubmissions AssignmentSubmission[]

  // Consultation Relations
  consultantProfile    ConsultantProfile?
  consultationRequests ConsultationRequest[]
  consultationReviews  ConsultationReview[]
  chatMessages         ChatMessage[]
  sessionFiles         SessionFile[]

  @@map("users")
}

model Role {
  id          String   @id @default(uuid())
  name        String   @unique
  displayName String   @map("display_name")
  description String?
  createdAt   DateTime @default(now()) @map("created_at")

  // Relations
  userRoles       UserRole[]
  rolePermissions RolePermission[]

  @@map("roles")
}

model Permission {
  id          String   @id @default(uuid())
  name        String   @unique
  displayName String   @map("display_name")
  description String?
  createdAt   DateTime @default(now()) @map("created_at")

  // Relations
  rolePermissions RolePermission[]

  @@map("permissions")
}

model UserRole {
  userId     String   @map("user_id")
  roleId     String   @map("role_id")
  assignedAt DateTime @default(now()) @map("assigned_at")

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)
  role Role @relation(fields: [roleId], references: [id], onDelete: Cascade)

  @@id([userId, roleId])
  @@map("user_roles")
}

model RolePermission {
  roleId       String @map("role_id")
  permissionId String @map("permission_id")

  role       Role       @relation(fields: [roleId], references: [id], onDelete: Cascade)
  permission Permission @relation(fields: [permissionId], references: [id], onDelete: Cascade)

  @@id([roleId, permissionId])
  @@map("role_permissions")
}

// ============================================
// ASSESSMENT SYSTEM
// ============================================

model Assessment {
  id          String    @id @default(uuid())
  userId      String    @map("user_id")
  templateId  String?   @map("template_id")
  status      String    @default("draft") // draft, in_progress, completed
  startedAt   DateTime? @map("started_at")
  completedAt DateTime? @map("completed_at")
  createdAt   DateTime  @default(now()) @map("created_at")
  updatedAt   DateTime  @updatedAt @map("updated_at")

  // Relations
  user            User                       @relation(fields: [userId], references: [id], onDelete: Cascade)
  template        AssessmentTemplate?        @relation(fields: [templateId], references: [id])
  responses       AssessmentResponse[]
  score           AssessmentScore?
  recommendations AssessmentRecommendation[]

  @@map("assessments")
}

model AssessmentTemplate {
  id          String   @id @default(uuid())
  title       String
  description String?
  category    String // e.g., "General", "F&B", "Retail"
  isActive    Boolean  @default(true) @map("is_active")
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")

  questions           AssessmentQuestion[]
  assessments         Assessment[]
  recommendationRules RecommendationRule[]

  @@map("assessment_templates")
}

model AssessmentCategory {
  id          String  @id @default(uuid())
  name        String
  description String?
  weight      Decimal @default(1.0) @db.Decimal(3, 2)

  questions           AssessmentQuestion[]
  recommendationRules RecommendationRule[]

  @@map("assessment_categories")
}

model AssessmentQuestion {
  id         String  @id @default(uuid())
  templateId String  @map("template_id")
  categoryId String  @map("category_id")
  text       String
  type       String // multiple_choice, scale, boolean, text
  options    Json? // For multiple choice
  weight     Decimal @default(1.0) @db.Decimal(3, 2)
  order      Int     @default(0)
  isRequired Boolean @default(true) @map("is_required")

  template  AssessmentTemplate   @relation(fields: [templateId], references: [id])
  category  AssessmentCategory   @relation(fields: [categoryId], references: [id])
  responses AssessmentResponse[]

  @@map("assessment_questions")
}

model AssessmentResponse {
  id           String   @id @default(uuid())
  assessmentId String   @map("assessment_id")
  questionId   String   @map("question_id")
  answerValue  Json     @map("answer_value")
  createdAt    DateTime @default(now()) @map("created_at")

  assessment Assessment         @relation(fields: [assessmentId], references: [id], onDelete: Cascade)
  question   AssessmentQuestion @relation(fields: [questionId], references: [id])

  @@unique([assessmentId, questionId])
  @@map("assessment_responses")
}

model AssessmentScore {
  id              String   @id @default(uuid())
  assessmentId    String   @unique @map("assessment_id")
  totalScore      Decimal  @map("total_score") @db.Decimal(5, 2)
  umkmLevel       String   @map("umkm_level") // mikro, kecil, menengah
  confidenceScore Decimal? @map("confidence_score") @db.Decimal(3, 2)
  categoryScores  Json     @map("category_scores")
  calculatedAt    DateTime @default(now()) @map("calculated_at")

  assessment Assessment @relation(fields: [assessmentId], references: [id], onDelete: Cascade)

  @@map("assessment_scores")
}

model RecommendationRule {
  id         String  @id @default(uuid())
  templateId String  @map("template_id")
  categoryId String? @map("category_id")

  // Condition
  minScore Decimal? @db.Decimal(5, 2)
  maxScore Decimal? @db.Decimal(5, 2)

  // Output
  title       String
  description String
  priority    String // high, medium, low
  actionItems Json // Array of strings
  resources   Json? // Array of { title, type, url }

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  template AssessmentTemplate  @relation(fields: [templateId], references: [id])
  category AssessmentCategory? @relation(fields: [categoryId], references: [id])

  @@map("recommendation_rules")
}

model AssessmentRecommendation {
  id           String @id @default(uuid())
  assessmentId String @map("assessment_id")

  title       String
  description String
  priority    String
  category    String
  actionItems Json
  resources   Json?

  createdAt DateTime @default(now()) @map("created_at")

  assessment Assessment @relation(fields: [assessmentId], references: [id], onDelete: Cascade)

  @@map("assessment_recommendations")
}

// ============================================
// PROFILES & DOCUMENTS
// ============================================

model UMKMProfile {
  id     String @id @default(uuid())
  userId String @unique @map("user_id")

  // Business Details
  businessName String  @map("business_name")
  ownerName    String  @map("owner_name")
  nib          String? // Nomor Induk Berusaha
  npwp         String? // Nomor Pokok Wajib Pajak
  address      String?
  province     String?
  city         String?
  district     String? // Kecamatan
  village      String? // Kelurahan/Desa
  postalCode   String? @map("postal_code")
  location     Json? // { lat: number, lng: number }
  phone        String?
  email        String?
  website      String?

  // Business Metrics
  sector      String? // Kuliner, Fashion, etc. (To be deprecated in favor of categoryId)
  turnover    Decimal? @db.Decimal(15, 2) // Omzet per tahun
  assets      Decimal? @db.Decimal(15, 2) // Total aset
  employees   Int?
  foundedYear Int?     @map("founded_year")

  // New Fields for Detailed Profile
  productionCapacity String?  @map("production_capacity")
  salesChannels      Json?    @map("sales_channels") // Array of strings
  socialMedia        Json?    @map("social_media") // Object
  omzetMonthly       Decimal? @map("omzet_monthly") @db.Decimal(15, 2)
  legalStatus        Json?    @map("legal_status") // Object { nib: true, etc }

  // Status & Segmentation
  level              String? // Mikro, Kecil, Menengah (Calculated)
  segmentation       String? // Pemula, Madya, Utama
  segmentationReason String? @map("segmentation_reason")
  status             String  @default("unverified") // unverified, submitted, in_review, verified, rejected

  // Scores
  selfAssessmentScore Decimal? @map("self_assessment_score") @db.Decimal(5, 2)
  readinessIndex      Json?    @map("readiness_index") // { finance: 80, digital: 50, ... }

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  // Relations
  user              User               @relation(fields: [userId], references: [id], onDelete: Cascade)
  documents         Document[]
  mentoringSessions MentoringSession[]

  categoryId String?       @map("category_id")
  category   UMKMCategory? @relation(fields: [categoryId], references: [id])
  tags       UMKMTag[]

  @@map("umkm_profiles")
}

model UMKMCategory {
  id          String   @id @default(uuid())
  name        String   @unique
  slug        String   @unique
  description String?
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")

  profiles UMKMProfile[]

  @@map("umkm_categories")
}

model UMKMTag {
  id        String   @id @default(uuid())
  name      String   @unique
  color     String? // hex code
  createdAt DateTime @default(now()) @map("created_at")

  profiles UMKMProfile[]

  @@map("umkm_tags")
}

model MentorProfile {
  id     String @id @default(uuid())
  userId String @unique @map("user_id")

  title      String? // e.g., "Senior Business Consultant"
  bio        String?  @db.Text
  expertise  String[] // Array of strings: ["Marketing", "Finance"]
  experience Int? // Years of experience
  linkedIn   String?  @map("linkedin_url")

  isVerified Boolean @default(false) @map("is_verified")
  rating     Decimal @default(0) @db.Decimal(3, 2)

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  // Relations
  user              User               @relation(fields: [userId], references: [id], onDelete: Cascade)
  mentoringSessions MentoringSession[]

  @@map("mentor_profiles")
}

model Document {
  id            String  @id @default(uuid())
  umkmProfileId String? @map("umkm_profile_id")

  type     String // NIB, NPWP, KTP, SKU, Other
  number   String? // Document number
  fileUrl  String  @map("file_url")
  fileName String  @map("file_name")
  fileSize Int?    @map("file_size")
  mimeType String? @map("mime_type")

  status          String    @default("pending") // pending, verified, rejected
  verifiedAt      DateTime? @map("verified_at")
  verifiedBy      String?   @map("verified_by")
  rejectionReason String?   @map("rejection_reason")
  expiryDate      DateTime? @map("expiry_date")

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  // Relations
  umkmProfile UMKMProfile? @relation(fields: [umkmProfileId], references: [id], onDelete: Cascade)

  @@map("documents")
}

model MentoringSession {
  id            String @id @default(uuid())
  umkmProfileId String @map("umkm_profile_id")
  mentorId      String @map("mentor_id")

  date        DateTime
  topic       String
  notes       String?  @db.Text
  nextAction  String?  @map("next_action")
  status      String   @default("done") // done, in_progress, need_attention
  tags        String[] // Branding, Finance, etc.
  attachments Json? // Array of { url, name }

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  // Relations
  umkmProfile UMKMProfile   @relation(fields: [umkmProfileId], references: [id])
  mentor      MentorProfile @relation(fields: [mentorId], references: [id])

  @@map("mentoring_sessions")
}

// ============================================
// SYSTEM & LOGS
// ============================================

model AuditLog {
  id     String  @id @default(uuid())
  userId String? @map("user_id")

  action     String // LOGIN, CREATE, UPDATE, DELETE
  resource   String // users, assessments, etc.
  resourceId String? @map("resource_id")

  oldValue Json? @map("old_value")
  newValue Json? @map("new_value")

  ipAddress String? @map("ip_address")
  userAgent String? @map("user_agent")

  createdAt DateTime @default(now()) @map("created_at")

  // Relations
  user User? @relation(fields: [userId], references: [id], onDelete: SetNull)

  @@index([userId])
  @@index([resource, resourceId])
  @@map("audit_logs")
}

// ============================================
// LEARNING HUB (LMS)
// ============================================

model Course {
  id               String  @id @default(uuid())
  title            String
  slug             String  @unique
  description      String  @db.Text
  thumbnail        String?
  level            String // Beginner, Intermediate, Advanced
  category         String
  price            Decimal @default(0) @db.Decimal(10, 2)
  isPaid           Boolean @default(false) @map("is_paid")
  isPublished      Boolean @default(false) @map("is_published")
  isFeatured       Boolean @default(false) @map("is_featured")
  duration         Int      @default(0) // in minutes
  language         String  @default("Indonesian")
  requirements     String? @db.Text
  learningOutcomes String? @map("learning_outcomes") @db.Text
  targetAudience   String? @map("target_audience") @db.Text
  authorId         String  @map("author_id")

  // NEW: Link to Consultant Instructor
  instructorId String? @map("instructor_id")

  enrollmentCount Int      @default(0) @map("enrollment_count")
  rating          Float    @default(0)
  reviewCount     Int      @default(0) @map("review_count")
  createdAt       DateTime @default(now()) @map("created_at")
  updatedAt       DateTime @updatedAt @map("updated_at")

  // Relations
  author           User               @relation(fields: [authorId], references: [id])
  instructor       ConsultantProfile? @relation("InstructorCourses", fields: [instructorId], references: [id])
  modules          Module[]
  enrollments      Enrollment[]
  CourseCategory   CourseCategory?    @relation(fields: [courseCategoryId], references: [id])
  courseCategoryId String?

  @@map("courses")
}

model CourseCategory {
  id          String   @id @default(uuid())
  name        String   @unique
  slug        String   @unique
  description String?
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")

  courses Course[]

  @@map("course_categories")
}

model Module {
  id       String @id @default(uuid())
  courseId String @map("course_id")
  title    String
  order    Int    @default(0)

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  // Relations
  course  Course   @relation(fields: [courseId], references: [id], onDelete: Cascade)
  lessons Lesson[]

  @@map("modules")
}

model Lesson {
  id          String  @id @default(uuid())
  moduleId    String  @map("module_id")
  title       String
  slug        String  @unique
  type        String  @default("video") // video, article, quiz, pdf, slide, link
  content     String? @db.Text // For articles
  videoUrl    String? @map("video_url") // For video lessons
  resourceUrl String? @map("resource_url") // For pdf, slide, link
  attachments Json? // Array of { title, url, type }
  duration    Int     @default(0) // in minutes
  order       Int     @default(0)
  isFree      Boolean @default(false) @map("is_free") // Preview allowed

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  // Relations
  module     Module           @relation(fields: [moduleId], references: [id], onDelete: Cascade)
  progress   LessonProgress[]
  quiz       Quiz?
  assignment Assignment?

  @@map("lessons")
}

model Enrollment {
  id          String    @id @default(uuid())
  userId      String    @map("user_id")
  courseId    String    @map("course_id")
  status      String    @default("active") // active, completed, dropped
  progress    Int       @default(0) // 0-100
  enrolledAt  DateTime  @default(now()) @map("enrolled_at")
  completedAt DateTime? @map("completed_at")

  // Relations
  user           User             @relation(fields: [userId], references: [id], onDelete: Cascade)
  course         Course           @relation(fields: [courseId], references: [id], onDelete: Cascade)
  lessonProgress LessonProgress[]

  @@unique([userId, courseId])
  @@map("enrollments")
}

model LessonProgress {
  id           String    @id @default(uuid())
  enrollmentId String    @map("enrollment_id")
  lessonId     String    @map("lesson_id")
  isCompleted  Boolean   @default(false) @map("is_completed")
  completedAt  DateTime? @map("completed_at")
  lastWatched  Int       @default(0) @map("last_watched") // timestamp in seconds

  // Relations
  enrollment Enrollment @relation(fields: [enrollmentId], references: [id], onDelete: Cascade)
  lesson     Lesson     @relation(fields: [lessonId], references: [id], onDelete: Cascade)

  @@unique([enrollmentId, lessonId])
  @@map("lesson_progress")
}

// ============================================
// LMS ASSESSMENT SYSTEM (QUIZ & ASSIGNMENT)
// ============================================

model Quiz {
  id           String  @id @default(uuid())
  lessonId     String  @unique @map("lesson_id")
  title        String
  description  String? @db.Text
  timeLimit    Int?    @map("time_limit") // in minutes
  passingScore Int     @default(70) @map("passing_score") // percentage

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  lesson    Lesson         @relation(fields: [lessonId], references: [id], onDelete: Cascade)
  questions QuizQuestion[]
  attempts  QuizAttempt[]

  @@map("lms_quizzes")
}

model QuizQuestion {
  id      String @id @default(uuid())
  quizId  String @map("quiz_id")
  text    String @db.Text
  type    String // multiple_choice, boolean, text
  options Json? // Array of { text, isCorrect }
  points  Int    @default(1)
  order   Int    @default(0)

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  quiz Quiz @relation(fields: [quizId], references: [id], onDelete: Cascade)

  @@map("lms_quiz_questions")
}

model QuizAttempt {
  id          String    @id @default(uuid())
  quizId      String    @map("quiz_id")
  userId      String    @map("user_id")
  score       Int       @default(0)
  isPassed    Boolean   @default(false) @map("is_passed")
  answers     Json? // Store user answers
  startedAt   DateTime  @default(now()) @map("started_at")
  completedAt DateTime? @map("completed_at")

  quiz Quiz @relation(fields: [quizId], references: [id], onDelete: Cascade)
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("lms_quiz_attempts")
}

model Assignment {
  id          String    @id @default(uuid())
  lessonId    String    @unique @map("lesson_id")
  title       String
  description String    @db.Text
  dueDate     DateTime? @map("due_date")

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  lesson      Lesson                 @relation(fields: [lessonId], references: [id], onDelete: Cascade)
  submissions AssignmentSubmission[]

  @@map("lms_assignments")
}

model AssignmentSubmission {
  id           String  @id @default(uuid())
  assignmentId String  @map("assignment_id")
  userId       String  @map("user_id")
  fileUrl      String? @map("file_url")
  content      String? @db.Text
  grade        Int?
  feedback     String? @db.Text
  status       String  @default("submitted") // submitted, graded, returned

  submittedAt DateTime  @default(now()) @map("submitted_at")
  gradedAt    DateTime? @map("graded_at")

  assignment Assignment @relation(fields: [assignmentId], references: [id], onDelete: Cascade)
  user       User       @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("lms_assignment_submissions")
}

// ============================================
// MARKETPLACE
// ============================================

// ============================================
// MARKETPLACE CORE
// ============================================

model Store {
  id          String  @id @default(uuid())
  userId      String  @unique @map("user_id") // One store per user for now
  name        String
  slug        String  @unique
  description String? @db.Text
  logoUrl     String? @map("logo_url")
  bannerUrl   String? @map("banner_url")

  // Policy
  refundPolicy   String? @map("refund_policy") @db.Text
  shippingPolicy String? @map("shipping_policy") @db.Text

  // Metrics
  rating     Decimal @default(0) @db.Decimal(3, 2)
  totalSales Int     @default(0) @map("total_sales")

  isActive  Boolean  @default(true) @map("is_active")
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  user     User      @relation(fields: [userId], references: [id])
  products Product[]
  orders   Order[]
  reviews  Review[]

  @@map("stores")
}

model Product {
  id          String  @id @default(uuid())
  storeId     String? @map("store_id") // Optional for migration, make required later
  title       String
  slug        String  @unique
  description String? @db.Text
  price       Decimal @default(0) @db.Decimal(15, 2)
  stock       Int     @default(0)
  weight      Int     @default(0) // in grams
  category    String? // Deprecated in favor of categoryId? Or keep for simple string
  categoryId  String? @map("category_id")

  status        String @default("draft") // draft, active, suspended, rejected
  images        Json? // Array of strings
  externalLinks Json?  @map("external_links") // { shopee: "url", tokopedia: "url" }

  // Legacy field to be migrated
  sellerId String? @map("seller_id")

  // Analytics
  viewCount Int     @default(0) @map("view_count")
  soldCount Int     @default(0) @map("sold_count")
  rating    Decimal @default(0) @db.Decimal(3, 2)

  isPublished Boolean   @default(false) @map("is_published")
  createdAt   DateTime  @default(now()) @map("created_at")
  updatedAt   DateTime  @updatedAt @map("updated_at")
  deletedAt   DateTime? @map("deleted_at") // Soft delete

  store           Store?                      @relation(fields: [storeId], references: [id])
  seller          User?                       @relation(fields: [sellerId], references: [id]) // Keep for backward compat during migration
  cartItems       CartItem[]
  orderItems      OrderItem[]
  reviews         Review[]
  channelProducts MarketplaceChannelProduct[]

  @@map("products")
}

model Cart {
  id        String   @id @default(uuid())
  userId    String   @unique @map("user_id")
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  user  User       @relation(fields: [userId], references: [id])
  items CartItem[]

  @@map("carts")
}

model CartItem {
  id        String  @id @default(uuid())
  cartId    String  @map("cart_id")
  productId String  @map("product_id")
  quantity  Int     @default(1)

  cart    Cart            @relation(fields: [cartId], references: [id], onDelete: Cascade)
  product Product         @relation(fields: [productId], references: [id])

  @@map("cart_items")
}

model Order {
  id      String  @id @default(uuid())
  userId  String  @map("user_id")
  storeId String? @map("store_id") // Optional for migration

  // Status
  status String @default("pending")
  // pending, awaiting_payment, paid, processing, shipped, completed, cancelled, refund_requested, refunded

  // Financials
  totalAmount    Decimal @map("total_amount") @db.Decimal(15, 2)
  shippingCost   Decimal @default(0) @map("shipping_cost") @db.Decimal(15, 2)
  platformFee    Decimal @default(0) @map("platform_fee") @db.Decimal(15, 2)
  discountAmount Decimal @default(0) @map("discount_amount") @db.Decimal(15, 2)

  paymentLink   String? @map("payment_link")
  paymentStatus String  @default("unpaid") @map("payment_status")

  // Shipping
  shippingAddress Json? // Snapshot of address
  courier         String?
  trackingNumber  String? @map("tracking_number")

  // Cancellation Information
  cancellationReason String?   @map("cancellation_reason")
  cancelledAt        DateTime? @map("cancelled_at")
  cancelledBy        String?   @map("cancelled_by") // buyer, seller, system

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  user     User        @relation(fields: [userId], references: [id])
  store    Store?      @relation(fields: [storeId], references: [id])
  items    OrderItem[]
  payment  Payment?
  shipment Shipment?
  reviews  Review[]

  @@map("orders")
}

model OrderItem {
  id        String  @id @default(uuid())
  orderId   String  @map("order_id")
  productId String  @map("product_id")

  quantity Int     @default(1)
  price    Decimal @db.Decimal(15, 2) // Price at purchase time
  name     String? // Product name snapshot

  order   Order           @relation(fields: [orderId], references: [id], onDelete: Cascade)
  product Product         @relation(fields: [productId], references: [id])

  @@map("order_items")
}

model Payment {
  id      String @id @default(uuid())
  orderId String @unique @map("order_id")

  method     String // midtrans, xendit, manual
  provider   String? // gopay, bca_va, etc.
  externalId String? @map("external_id") // Transaction ID from gateway
  status     String // pending, success, failed, expired
  amount     Decimal @db.Decimal(15, 2)
  paymentUrl String? @map("payment_url")

  paidAt    DateTime? @map("paid_at")
  createdAt DateTime  @default(now()) @map("created_at")
  updatedAt DateTime  @updatedAt @map("updated_at")

  order Order @relation(fields: [orderId], references: [id])

  @@map("payments")
}

model Shipment {
  id      String @id @default(uuid())
  orderId String @unique @map("order_id")

  courier        String
  service        String // REG, YES, etc.
  trackingNumber String? @map("tracking_number")
  status         String // pending, picked_up, in_transit, delivered, returned

  shippedAt   DateTime? @map("shipped_at")
  deliveredAt DateTime? @map("delivered_at")

  order Order @relation(fields: [orderId], references: [id])

  @@map("shipments")
}

model Review {
  id        String @id @default(uuid())
  userId    String @map("user_id")
  storeId   String @map("store_id")
  productId String @map("product_id")
  orderId   String @map("order_id")

  rating  Int // 1-5
  comment String? @db.Text
  images  Json? // Array of strings

  createdAt DateTime @default(now()) @map("created_at")

  user    User    @relation(fields: [userId], references: [id])
  store   Store   @relation(fields: [storeId], references: [id])
  product Product @relation(fields: [productId], references: [id])
  order   Order   @relation(fields: [orderId], references: [id])

  @@map("reviews")
}

// ============================================
// EXTERNAL MARKETPLACE INTEGRATION
// ============================================

model MarketplaceChannelSync {
  id      String @id @default(uuid())
  storeId String @map("store_id")
  channel String // tokopedia, shopee, tiktok

  accessToken  String    @map("access_token") @db.Text
  refreshToken String?   @map("refresh_token") @db.Text
  expiresAt    DateTime? @map("expires_at")

  shopId   String? @map("shop_id") // External Shop ID
  isActive Boolean @default(true) @map("is_active")

  lastSyncAt DateTime? @map("last_sync_at")
  createdAt  DateTime  @default(now()) @map("created_at")
  updatedAt  DateTime  @updatedAt @map("updated_at")

  @@map("marketplace_channel_syncs")
}

model MarketplaceChannelProduct {
  id         String @id @default(uuid())
  productId  String @map("product_id")
  channel    String // tokopedia, shopee
  externalId String @map("external_id") // ID in external platform

  syncStatus String    @default("synced") // synced, error, pending
  lastSyncAt DateTime? @map("last_sync_at")

  product Product @relation(fields: [productId], references: [id], onDelete: Cascade)

  @@unique([productId, channel])
  @@map("marketplace_channel_products")
}

// ============================================
// FINANCING HUB
// ============================================

model FinancingPartner {
  id           String  @id @default(uuid())
  name         String
  slug         String  @unique
  provider     String // e.g., "Bank Mandiri"
  type         String // KUR, Fintech, etc.
  maxAmount    Decimal @map("max_amount") @db.Decimal(15, 2)
  interestRate String  @map("interest_rate")
  term         String
  requirements Json // Array of strings
  features     Json // Array of strings
  description  String  @db.Text
  logoUrl      String? @map("logo_url")
  isActive     Boolean @default(true) @map("is_active")

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  applications LoanApplication[]

  @@map("financing_partners")
}

model LoanApplication {
  id        String @id @default(uuid())
  userId    String @map("user_id")
  partnerId String @map("partner_id")

  amount  Decimal @db.Decimal(15, 2)
  term    Int // in months
  purpose String
  status  String  @default("submitted") // submitted, review, approved, rejected, disbursed
  notes   String? @db.Text

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  // Relations
  user      User             @relation(fields: [userId], references: [id], onDelete: Cascade)
  partner   FinancingPartner @relation(fields: [partnerId], references: [id])
  documents LoanDocument[]

  @@map("loan_applications")
}

model LoanDocument {
  id            String @id @default(uuid())
  applicationId String @map("application_id")

  type     String // KTP, NPWP, SIUP, etc.
  fileUrl  String  @map("file_url")
  fileName String  @map("file_name")
  fileSize Int?    @map("file_size")
  mimeType String? @map("mime_type")

  status String @default("pending") // pending, verified, rejected

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  // Relations
  application LoanApplication @relation(fields: [applicationId], references: [id], onDelete: Cascade)

  @@map("loan_documents")
}

// ============================================
// EXPORT HUB
// ============================================

model ExportHSCode {
  id           String  @id @default(uuid())
  code         String  @unique
  description  String
  tariff       String?
  requirements Json? // Array of strings
  category     String?

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  @@map("export_hs_codes")
}

model ExportCountry {
  id           String  @id @default(uuid())
  name         String  @unique
  code         String  @unique // ISO code e.g. MY, SG
  flag         String? // Emoji or URL
  market       String? // ASEAN, EU, etc.
  distance     String?
  shippingTime String? @map("shipping_time")
  avgTariff    String? @map("avg_tariff")
  requirements Json? // Array of strings
  topProducts  Json? // Array of strings

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  buyers ExportBuyer[]

  @@map("export_countries")
}

model ExportBuyer {
  id          String  @id @default(uuid())
  companyName String  @map("company_name")
  countryId   String  @map("country_id")
  category    String?
  products    Json? // Array of strings
  volume      String?
  isVerified  Boolean @default(false) @map("is_verified")
  rating      Decimal @default(0) @db.Decimal(3, 2)
  contactInfo Json?   @map("contact_info")

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  country ExportCountry @relation(fields: [countryId], references: [id])

  @@map("export_buyers")
}

// ============================================
// COMMUNITY PLATFORM (FORUM & EVENTS)
// ============================================

model ForumCategory {
  id          String  @id @default(uuid())
  name        String
  description String?
  slug        String  @unique
  icon        String?
  order       Int     @default(0)

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  threads ForumThread[]

  @@map("forum_categories")
}

model ForumThread {
  id         String  @id @default(uuid())
  title      String
  content    String  @db.Text
  authorId   String  @map("author_id")
  categoryId String  @map("category_id")
  views      Int     @default(0)
  isPinned   Boolean @default(false) @map("is_pinned")
  isLocked   Boolean @default(false) @map("is_locked")

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  author   User          @relation(fields: [authorId], references: [id])
  category ForumCategory @relation(fields: [categoryId], references: [id])
  posts    ForumPost[]
  upvotes  ForumUpvote[]

  @@map("forum_threads")
}

model ForumPost {
  id       String  @id @default(uuid())
  content  String  @db.Text
  threadId String  @map("thread_id")
  authorId String  @map("author_id")
  parentId String? @map("parent_id") // For nested replies

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  thread  ForumThread   @relation(fields: [threadId], references: [id], onDelete: Cascade)
  author  User          @relation(fields: [authorId], references: [id])
  parent  ForumPost?    @relation("PostReplies", fields: [parentId], references: [id])
  replies ForumPost[]   @relation("PostReplies")
  upvotes ForumUpvote[]

  @@map("forum_posts")
}

model ForumUpvote {
  id       String  @id @default(uuid())
  userId   String  @map("user_id")
  threadId String? @map("thread_id")
  postId   String? @map("post_id")

  createdAt DateTime @default(now()) @map("created_at")

  user   User         @relation(fields: [userId], references: [id])
  thread ForumThread? @relation(fields: [threadId], references: [id], onDelete: Cascade)
  post   ForumPost?   @relation(fields: [postId], references: [id], onDelete: Cascade)

  @@unique([userId, threadId, postId]) // Prevent double voting
  @@map("forum_upvotes")
}

model Event {
  id              String   @id @default(uuid())
  title           String
  description     String   @db.Text
  bannerUrl       String?  @map("banner_url")
  startDate       DateTime @map("start_date")
  endDate         DateTime @map("end_date")
  location        String
  type            String // 'online' | 'offline'
  maxParticipants Int?     @map("max_participants")
  organizerId     String   @map("organizer_id")

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  organizer     User                @relation(fields: [organizerId], references: [id])
  registrations EventRegistration[]

  @@map("events")
}

model EventRegistration {
  id           String   @id @default(uuid())
  eventId      String   @map("event_id")
  userId       String   @map("user_id")
  status       String   @default("registered") // registered, attended, cancelled
  registeredAt DateTime @default(now()) @map("registered_at")

  event Event @relation(fields: [eventId], references: [id], onDelete: Cascade)
  user  User  @relation(fields: [userId], references: [id])

  @@unique([eventId, userId])
  @@map("event_registrations")
}

// ============================================
// PROGRAM MANAGEMENT (INCUBATION & TRAINING)
// ============================================

model Program {
  id          String   @id @default(uuid())
  title       String
  description String   @db.Text
  type        String // incubator, accelerator, training
  status      String   @default("draft") // draft, active, completed
  bannerUrl   String?  @map("banner_url")
  startDate   DateTime @map("start_date")
  endDate     DateTime @map("end_date")
  organizerId String   @map("organizer_id")

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  organizer  User               @relation(fields: [organizerId], references: [id])
  batches    ProgramBatch[]
  milestones ProgramMilestone[]

  @@map("programs")
}

model ProgramBatch {
  id              String   @id @default(uuid())
  programId       String   @map("program_id")
  name            String // e.g., "Batch 1", "Angkatan 2024"
  startDate       DateTime @map("start_date")
  endDate         DateTime @map("end_date")
  maxParticipants Int      @map("max_participants")

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  program      Program              @relation(fields: [programId], references: [id], onDelete: Cascade)
  participants ProgramParticipant[]

  @@map("program_batches")
}

model ProgramParticipant {
  id       String   @id @default(uuid())
  batchId  String   @map("batch_id")
  userId   String   @map("user_id")
  status   String   @default("applied") // applied, accepted, rejected, graduated, dropped
  joinedAt DateTime @default(now()) @map("joined_at")
  notes    String?  @db.Text

  batch ProgramBatch @relation(fields: [batchId], references: [id], onDelete: Cascade)
  user  User         @relation(fields: [userId], references: [id])

  @@unique([batchId, userId])
  @@map("program_participants")
}

model ProgramMilestone {
  id          String  @id @default(uuid())
  programId   String  @map("program_id")
  title       String
  description String?
  order       Int     @default(0)

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  program Program @relation(fields: [programId], references: [id], onDelete: Cascade)

  @@map("program_milestones")
}

// ============================================
// CONSULTATION HUB
// ============================================

model ConsultantProfile {
  id                    String   @id @default(uuid())
  userId                String   @unique @map("user_id")
  consultationTypeId    String?  @map("consultation_type_id")
  title                 String
  tagline               String?
  bio                   String   @db.Text
  expertiseAreas        String[] @map("expertise_areas")
  industries            String[] @default([])
  languages             String[] @default(["Indonesian"])
  yearsExperience       Int      @map("years_experience")
  certifications        String?  @db.Text
  education             String?  @db.Text
  hourlyRate            Int      @map("hourly_rate")
  averageRating         Float    @default(0) @map("average_rating")
  totalSessions         Int      @default(0) @map("total_sessions")
  totalEarnings         Float    @default(0) @map("total_earnings")
  isAcceptingNewClients Boolean  @default(true) @map("is_accepting_new_clients")
  isFeatured            Boolean  @default(false) @map("is_featured")
  videoIntroUrl         String?  @map("video_intro_url")
  cancellationPolicy    String?  @map("cancellation_policy") @db.Text
  status                String   @default("pending") // pending, approved, rejected, suspended
  verificationStatus    String   @default("unverified") @map("verification_status") // unverified, verified

  // NEW: LMS Instructor Capability
  canTeachCourses     Boolean @default(false) @map("can_teach_courses")
  instructorBio       String? @map("instructor_bio") @db.Text
  totalCoursesCreated Int     @default(0) @map("total_courses_created")
  totalStudents       Int     @default(0) @map("total_students")

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  // Relations
  user                 User                     @relation(fields: [userId], references: [id], onDelete: Cascade)
  consultationType     ConsultationType?        @relation(fields: [consultationTypeId], references: [id])
  availability         ConsultantAvailability[]
  consultationRequests ConsultationRequest[]
  reviews              ConsultationReview[]

  // NEW: LMS Relations
  courses Course[] @relation("InstructorCourses")

  @@map("consultant_profiles")
}

model ConsultantAvailability {
  id           String @id @default(uuid())
  consultantId String @map("consultant_id")

  dayOfWeek   Int?     @map("day_of_week")
  startTime   DateTime @map("start_time") @db.Time
  endTime     DateTime @map("end_time") @db.Time
  isRecurring Boolean  @default(true) @map("is_recurring")

  specificDate DateTime? @map("specific_date") @db.Date
  isAvailable  Boolean   @default(true) @map("is_available")

  timezone String @default("Asia/Jakarta")

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  consultant ConsultantProfile @relation(fields: [consultantId], references: [id], onDelete: Cascade)

  @@map("consultant_availability")
}

model ConsultationType {
  id          String  @id @default(uuid())
  name        String  @unique
  slug        String  @unique
  description String? @db.Text
  iconUrl     String? @map("icon_url")

  category String?
  tags     String[]

  basePrice Decimal @default(0) @map("base_price") @db.Decimal(10, 2)
  duration  Int     @default(60) // minutes
  isPremium Boolean @default(false) @map("is_premium")

  isActive     Boolean @default(true) @map("is_active")
  requiresPrep Boolean @default(false) @map("requires_prep")

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  requests          ConsultationRequest[]
  ConsultantProfile ConsultantProfile[]

  @@map("consultation_types")
}

model ConsultationRequest {
  id           String  @id @default(uuid())
  clientId     String  @map("client_id")
  consultantId String  @map("consultant_id")
  typeId       String? @map("type_id")

  requestedDate      DateTime @map("requested_date") @db.Date
  requestedStartTime DateTime @map("requested_start_time") @db.Time
  requestedEndTime   DateTime @map("requested_end_time") @db.Time
  durationMinutes    Int      @map("duration_minutes")
  timezone           String   @default("Asia/Jakarta")

  topic        String
  description  String? @db.Text
  status       String  @default("pending") // pending, approved, rejected, cancelled, completed
  statusReason String? @map("status_reason")

  meetingUrl      String? @map("meeting_url")
  meetingPlatform String? @map("meeting_platform")

  sessionNotes    String? @map("session_notes") @db.Text

  isPaid      Boolean @default(false) @map("is_paid")
  quotedPrice Decimal @default(0) @map("quoted_price") @db.Decimal(10, 2)

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  client       User              @relation(fields: [clientId], references: [id])
  consultant   ConsultantProfile @relation(fields: [consultantId], references: [id])
  type         ConsultationType? @relation(fields: [typeId], references: [id])
  chatChannel  ChatChannel?
  sessionFiles SessionFile[]

  @@map("consultation_requests")
}

model ChatChannel {
  id        String  @id @default(uuid())
  requestId String  @unique @map("request_id")
  isActive  Boolean @default(true) @map("is_active")

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  request  ConsultationRequest @relation(fields: [requestId], references: [id], onDelete: Cascade)
  messages ChatMessage[]

  @@map("chat_channels")
}

model ChatMessage {
  id        String @id @default(uuid())
  channelId String @map("channel_id")
  senderId  String @map("sender_id")

  content     String? @db.Text
  contentType String  @default("text") @map("content_type") // text, image, file
  fileUrl     String? @map("file_url")

  isRead Boolean   @default(false) @map("is_read")
  readAt DateTime? @map("read_at")

  createdAt DateTime @default(now()) @map("created_at")

  channel ChatChannel @relation(fields: [channelId], references: [id], onDelete: Cascade)
  sender  User        @relation(fields: [senderId], references: [id])

  @@map("chat_messages")
}

model SessionFile {
  id         String @id @default(uuid())
  requestId  String @map("request_id")
  uploadedBy String @map("uploaded_by")

  fileName    String  @map("file_name")
  fileUrl     String  @map("file_url")
  fileSize    Int?    @map("file_size")
  mimeType    String? @map("mime_type")
  description String?

  createdAt DateTime @default(now()) @map("created_at")

  request  ConsultationRequest @relation(fields: [requestId], references: [id], onDelete: Cascade)
  uploader User                @relation(fields: [uploadedBy], references: [id])

  @@map("session_files")
}

model ConsultationReview {
  id           String @id @default(uuid())
  consultantId String @map("consultant_id")
  clientId     String @map("client_id")

  rating      Int
  comment     String? @db.Text
  isPublished Boolean @default(true) @map("is_published")

  createdAt DateTime @default(now()) @map("created_at")

  consultant ConsultantProfile @relation(fields: [consultantId], references: [id])
  client     User              @relation(fields: [clientId], references: [id])

  @@map("consultation_reviews")
}
