generator client {
  provider = "prisma-client-js"
  output   = "./generated/client"
}

datasource db {
  provider = "postgresql"
}

model User {
  id                String  @id @default(uuid())
  email             String  @unique
  passwordHash      String  @map("password_hash")
  fullName          String  @map("full_name")
  phone             String?
  businessName      String? @map("business_name")
  profilePictureUrl String? @map("profile_picture_url")

  // Personal Location (Owner Address)
  address  String?
  city     String?
  province String?
  location Json? // { lat: number, lng: number }

  emailVerified Boolean  @default(false) @map("email_verified")
  isActive      Boolean  @default(true) @map("is_active")
  createdAt     DateTime @default(now()) @map("created_at")
  updatedAt     DateTime @updatedAt @map("updated_at")

  // Relations
  userRoles        UserRole[]
  assessments      Assessment[]
  umkmProfiles     UMKMProfile[] // Changed from UMKMProfile? to allow 1:N
  mentorProfile    MentorProfile?
  auditLogs        AuditLog[]
  authoredCourses  Course[]
  enrollments      Enrollment[]
  products         Product[]
  orders           Order[]
  loanApplications LoanApplication[]

  // Marketplace Relations
  store   Store?
  cart    Cart?
  reviews Review[]

  // Community Relations
  forumThreads ForumThread[]
  forumPosts   ForumPost[]
  forumUpvotes ForumUpvote[]

  organizedEvents    Event[]
  eventRegistrations EventRegistration[]

  // Program Relations
  organizedPrograms     Program[]
  programParticipations ProgramParticipant[]
  quizAttempts          QuizAttempt[]
  assignmentSubmissions AssignmentSubmission[]
  sessionFiles          SessionFile[]
  createdExpertise      ExpertiseCategory[]
  expertiseAuditLogs    ExpertiseAuditLog[]
  consultantProfile     ConsultantProfile?
  consultationRequests  ConsultationRequest[]
  consultationReviews   ConsultationReview[]
  sentMessages          ChatMessage[]

  // Arsipari Relations
  createdIncomingLetters IncomingLetter[] @relation("IncomingLetterCreator")
  createdOutgoingLetters OutgoingLetter[] @relation("OutgoingLetterCreator")
  dispositionsFrom       Disposition[]    @relation("DispositionFrom")
  dispositionsTo         Disposition[]    @relation("DispositionTo")
  letterApprovals        LetterApproval[] @relation("LetterApprovalUser")
  createdArchives        Archive[]        @relation("ArchiveCreator")

  @@map("users")
}

model Role {
  id              String           @id @default(uuid())
  name            String           @unique
  displayName     String           @map("display_name")
  description     String?
  createdAt       DateTime         @default(now()) @map("created_at")
  rolePermissions RolePermission[]
  userRoles       UserRole[]

  @@map("roles")
}

model Permission {
  id              String           @id @default(uuid())
  name            String           @unique
  displayName     String           @map("display_name")
  description     String?
  createdAt       DateTime         @default(now()) @map("created_at")
  rolePermissions RolePermission[]

  @@map("permissions")
}

model UserRole {
  userId     String   @map("user_id")
  roleId     String   @map("role_id")
  assignedAt DateTime @default(now()) @map("assigned_at")
  role       Role     @relation(fields: [roleId], references: [id], onDelete: Cascade)
  user       User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@id([userId, roleId])
  @@map("user_roles")
}

model RolePermission {
  roleId       String     @map("role_id")
  permissionId String     @map("permission_id")
  permission   Permission @relation(fields: [permissionId], references: [id], onDelete: Cascade)
  role         Role       @relation(fields: [roleId], references: [id], onDelete: Cascade)

  @@id([roleId, permissionId])
  @@map("role_permissions")
}

model Assessment {
  id              String                     @id @default(uuid())
  userId          String                     @map("user_id")
  templateId      String?                    @map("template_id")
  status          String                     @default("draft")
  startedAt       DateTime?                  @map("started_at")
  completedAt     DateTime?                  @map("completed_at")
  createdAt       DateTime                   @default(now()) @map("created_at")
  updatedAt       DateTime                   @updatedAt @map("updated_at")
  recommendations AssessmentRecommendation[]
  responses       AssessmentResponse[]
  score           AssessmentScore?
  template        AssessmentTemplate?        @relation(fields: [templateId], references: [id])
  user            User                       @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("assessments")
}

model AssessmentTemplate {
  id                  String               @id @default(uuid())
  title               String
  description         String?
  category            String
  isActive            Boolean              @default(true) @map("is_active")
  createdAt           DateTime             @default(now()) @map("created_at")
  updatedAt           DateTime             @updatedAt @map("updated_at")
  questions           AssessmentQuestion[]
  assessments         Assessment[]
  recommendationRules RecommendationRule[]

  @@map("assessment_templates")
}

model AssessmentCategory {
  id                  String               @id @default(uuid())
  name                String
  description         String?
  weight              Decimal              @default(1.0) @db.Decimal(3, 2)
  questions           AssessmentQuestion[]
  recommendationRules RecommendationRule[]

  @@map("assessment_categories")
}

model AssessmentQuestion {
  id         String               @id @default(uuid())
  templateId String               @map("template_id")
  categoryId String               @map("category_id")
  text       String
  type       String
  options    Json?
  weight     Decimal              @default(1.0) @db.Decimal(3, 2)
  order      Int                  @default(0)
  isRequired Boolean              @default(true) @map("is_required")
  category   AssessmentCategory   @relation(fields: [categoryId], references: [id])
  template   AssessmentTemplate   @relation(fields: [templateId], references: [id])
  responses  AssessmentResponse[]

  @@map("assessment_questions")
}

model AssessmentResponse {
  id           String             @id @default(uuid())
  assessmentId String             @map("assessment_id")
  questionId   String             @map("question_id")
  answerValue  Json               @map("answer_value")
  createdAt    DateTime           @default(now()) @map("created_at")
  assessment   Assessment         @relation(fields: [assessmentId], references: [id], onDelete: Cascade)
  question     AssessmentQuestion @relation(fields: [questionId], references: [id])

  @@unique([assessmentId, questionId])
  @@map("assessment_responses")
}

model AssessmentScore {
  id              String     @id @default(uuid())
  assessmentId    String     @unique @map("assessment_id")
  totalScore      Decimal    @map("total_score") @db.Decimal(5, 2)
  umkmLevel       String     @map("umkm_level")
  confidenceScore Decimal?   @map("confidence_score") @db.Decimal(3, 2)
  categoryScores  Json       @map("category_scores")
  calculatedAt    DateTime   @default(now()) @map("calculated_at")
  assessment      Assessment @relation(fields: [assessmentId], references: [id], onDelete: Cascade)

  @@map("assessment_scores")
}

model RecommendationRule {
  id          String              @id @default(uuid())
  templateId  String              @map("template_id")
  categoryId  String?             @map("category_id")
  minScore    Decimal?            @db.Decimal(5, 2)
  maxScore    Decimal?            @db.Decimal(5, 2)
  title       String
  description String
  priority    String
  actionItems Json
  resources   Json?
  createdAt   DateTime            @default(now()) @map("created_at")
  updatedAt   DateTime            @updatedAt @map("updated_at")
  category    AssessmentCategory? @relation(fields: [categoryId], references: [id])
  template    AssessmentTemplate  @relation(fields: [templateId], references: [id])

  @@map("recommendation_rules")
}

model AssessmentRecommendation {
  id           String     @id @default(uuid())
  assessmentId String     @map("assessment_id")
  title        String
  description  String
  priority     String
  category     String
  actionItems  Json
  resources    Json?
  createdAt    DateTime   @default(now()) @map("created_at")
  assessment   Assessment @relation(fields: [assessmentId], references: [id], onDelete: Cascade)

  @@map("assessment_recommendations")
}

model UMKMProfile {
  id     String @id @default(uuid())
  userId String @map("user_id") // Removed @unique to allow 1 user -> many UMKM

  // Business Details
  businessName String  @map("business_name")
  ownerName    String  @map("owner_name")
  nib          String? // Nomor Induk Berusaha
  npwp         String? // Nomor Pokok Wajib Pajak
  address      String?
  province     String?
  city         String?
  district     String? // Kecamatan
  village      String? // Kelurahan/Desa
  postalCode   String? @map("postal_code")
  location     Json? // { lat: number, lng: number }
  phone        String?
  email        String?
  website      String?

  // Business Metrics
  sector      String? // Kuliner, Fashion, etc. (To be deprecated in favor of categoryId)
  turnover    Decimal? @db.Decimal(15, 2) // Omzet per tahun
  assets      Decimal? @db.Decimal(15, 2) // Total aset
  employees   Int?
  foundedYear Int?     @map("founded_year")

  // New Fields for Detailed Profile
  productionCapacity String?  @map("production_capacity")
  salesChannels      Json?    @map("sales_channels") // Array of strings
  socialMedia        Json?    @map("social_media") // Object
  omzetMonthly       Decimal? @map("omzet_monthly") @db.Decimal(15, 2)
  legalStatus        Json?    @map("legal_status") // Object { nib: true, etc }

  // Status & Segmentation
  level              String? // Mikro, Kecil, Menengah (Calculated)
  segmentation       String? // Pemula, Madya, Utama
  segmentationReason String? @map("segmentation_reason")
  status             String  @default("unverified") // unverified, submitted, in_review, verified, rejected

  // Scores
  selfAssessmentScore Decimal? @map("self_assessment_score") @db.Decimal(5, 2)
  readinessIndex      Json?    @map("readiness_index") // { finance: 80, digital: 50, ... }

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  // Relations
  user              User                  @relation(fields: [userId], references: [id], onDelete: Cascade)
  documents         Document[]
  mentoringSessions MentoringSession[]
  eventAttendances  MentorEventAttendee[]

  categoryId String?       @map("category_id")
  category   UMKMCategory? @relation(fields: [categoryId], references: [id])
  tags       UMKMTag[]     @relation("UMKMProfileToUMKMTag")

  @@map("umkm_profiles")
}

model UMKMCategory {
  id          String        @id @default(uuid())
  name        String        @unique
  slug        String        @unique
  description String?
  createdAt   DateTime      @default(now()) @map("created_at")
  updatedAt   DateTime      @updatedAt @map("updated_at")
  profiles    UMKMProfile[]

  @@map("umkm_categories")
}

model UMKMTag {
  id        String        @id @default(uuid())
  name      String        @unique
  color     String?
  createdAt DateTime      @default(now()) @map("created_at")
  profiles  UMKMProfile[] @relation("UMKMProfileToUMKMTag")

  @@map("umkm_tags")
}

model MentorProfile {
  id         String   @id @default(uuid())
  userId     String   @unique @map("user_id")
  title      String?
  bio        String?
  expertise  String[]
  experience Int?
  linkedIn   String?  @map("linkedin_url")
  isVerified Boolean  @default(false) @map("is_verified")
  rating     Decimal  @default(0) @db.Decimal(3, 2)
  createdAt  DateTime @default(now()) @map("created_at")
  updatedAt  DateTime @updatedAt @map("updated_at")

  user              User               @relation(fields: [userId], references: [id], onDelete: Cascade)
  mentoringSessions MentoringSession[]
  events            MentorEvent[]

  courses Course[] @relation("MentorCourses")

  @@map("mentor_profiles")
}

model Document {
  id              String       @id @default(uuid())
  umkmProfileId   String?      @map("umkm_profile_id")
  type            String
  number          String?
  fileUrl         String       @map("file_url")
  fileName        String       @map("file_name")
  fileSize        Int?         @map("file_size")
  mimeType        String?      @map("mime_type")
  status          String       @default("pending")
  verifiedAt      DateTime?    @map("verified_at")
  verifiedBy      String?      @map("verified_by")
  rejectionReason String?      @map("rejection_reason")
  createdAt       DateTime     @default(now()) @map("created_at")
  updatedAt       DateTime     @updatedAt @map("updated_at")
  expiryDate      DateTime?    @map("expiry_date")
  umkmProfile     UMKMProfile? @relation(fields: [umkmProfileId], references: [id], onDelete: Cascade)

  @@map("documents")
}

model MentoringSession {
  id            String        @id @default(uuid())
  umkmProfileId String        @map("umkm_profile_id")
  mentorId      String        @map("mentor_id")
  date          DateTime
  topic         String
  notes         String?
  nextAction    String?       @map("next_action")
  status        String        @default("done")
  tags          String[]
  attachments   Json?
  createdAt     DateTime      @default(now()) @map("created_at")
  updatedAt     DateTime      @updatedAt @map("updated_at")
  mentor        MentorProfile @relation(fields: [mentorId], references: [id])
  umkmProfile   UMKMProfile   @relation(fields: [umkmProfileId], references: [id])

  @@map("mentoring_sessions")
}

model MentorEvent {
  id       String @id @default(uuid())
  mentorId String @map("mentor_id")

  // Basic Info
  title       String
  slug        String  @unique
  description String  @db.Text
  thumbnail   String?

  // Location
  province  String
  city      String
  venue     String?
  address   String?  @db.Text
  latitude  Decimal? @db.Decimal(10, 8)
  longitude Decimal? @db.Decimal(11, 8)

  // Schedule
  startDate DateTime @map("start_date")
  endDate   DateTime @map("end_date")
  timezone  String   @default("Asia/Jakarta")

  // Capacity & Registration
  maxAttendees    Int       @default(50) @map("max_attendees")
  registrationEnd DateTime? @map("registration_end")

  // Status & Metadata
  type   String   @default("workshop") // workshop, gathering, training
  status String   @default("draft") // draft, published, cancelled, completed
  tags   String[]

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  // Relations
  mentor    MentorProfile         @relation(fields: [mentorId], references: [id])
  attendees MentorEventAttendee[]

  @@index([mentorId])
  @@index([province, city])
  @@index([startDate])
  @@map("mentor_events")
}

model MentorEventAttendee {
  id            String @id @default(uuid())
  eventId       String @map("event_id")
  umkmProfileId String @map("umkm_profile_id")

  status String  @default("registered") // registered, confirmed, attended, cancelled, no_show
  notes  String? @db.Text

  registeredAt DateTime  @default(now()) @map("registered_at")
  confirmedAt  DateTime? @map("confirmed_at")
  attendedAt   DateTime? @map("attended_at")
  cancelledAt  DateTime? @map("cancelled_at")

  // Relations
  event       MentorEvent @relation(fields: [eventId], references: [id], onDelete: Cascade)
  umkmProfile UMKMProfile @relation(fields: [umkmProfileId], references: [id])

  @@unique([eventId, umkmProfileId])
  @@index([eventId])
  @@index([umkmProfileId])
  @@map("mentor_event_attendees")
}

// ============================================
// SYSTEM & LOGS
// ============================================

model AuditLog {
  id         String   @id @default(uuid())
  userId     String?  @map("user_id")
  action     String
  resource   String
  resourceId String?  @map("resource_id")
  oldValue   Json?    @map("old_value")
  newValue   Json?    @map("new_value")
  ipAddress  String?  @map("ip_address")
  userAgent  String?  @map("user_agent")
  createdAt  DateTime @default(now()) @map("created_at")
  user       User?    @relation(fields: [userId], references: [id])

  @@index([userId])
  @@index([resource, resourceId])
  @@map("audit_logs")
}

model Course {
  id               String  @id @default(uuid())
  title            String
  slug             String  @unique
  description      String  @db.Text
  thumbnail        String?
  level            String // Beginner, Intermediate, Advanced
  category         String
  price            Decimal @default(0) @db.Decimal(10, 2)
  isPaid           Boolean @default(false) @map("is_paid")
  isPublished      Boolean @default(false) @map("is_published")
  isFeatured       Boolean @default(false) @map("is_featured")
  duration         Int     @default(0) // in minutes
  language         String  @default("Indonesian")
  requirements     String? @db.Text
  learningOutcomes String? @map("learning_outcomes") @db.Text
  targetAudience   String? @map("target_audience") @db.Text
  authorId         String  @map("author_id")

  // Link to Consultant Instructor
  instructorId String? @map("instructor_id")

  // Link to Mentor
  mentorId String? @map("mentor_id")

  // Access restriction
  isUMKMOnly Boolean @default(false) @map("is_umkm_only")

  enrollmentCount Int      @default(0) @map("enrollment_count")
  rating          Float    @default(0)
  reviewCount     Int      @default(0) @map("review_count")
  createdAt       DateTime @default(now()) @map("created_at")
  updatedAt       DateTime @updatedAt @map("updated_at")

  // Relations
  author           User               @relation(fields: [authorId], references: [id])
  instructor       ConsultantProfile? @relation("InstructorCourses", fields: [instructorId], references: [id])
  mentor           MentorProfile?     @relation("MentorCourses", fields: [mentorId], references: [id])
  modules          Module[]
  enrollments      Enrollment[]
  CourseCategory   CourseCategory?    @relation(fields: [courseCategoryId], references: [id])
  courseCategoryId String?

  @@index([mentorId])
  @@map("courses")
}

model CourseCategory {
  id          String   @id @default(uuid())
  name        String   @unique
  slug        String   @unique
  description String?
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")
  courses     Course[]

  @@map("course_categories")
}

model Module {
  id        String   @id @default(uuid())
  courseId  String   @map("course_id")
  title     String
  order     Int      @default(0)
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")
  lessons   Lesson[]
  course    Course   @relation(fields: [courseId], references: [id], onDelete: Cascade)

  @@map("modules")
}

model Lesson {
  id          String           @id @default(uuid())
  moduleId    String           @map("module_id")
  title       String
  slug        String           @unique
  type        String           @default("video")
  content     String?
  videoUrl    String?          @map("video_url")
  duration    Int              @default(0)
  order       Int              @default(0)
  isFree      Boolean          @default(false) @map("is_free")
  createdAt   DateTime         @default(now()) @map("created_at")
  updatedAt   DateTime         @updatedAt @map("updated_at")
  attachments Json?
  resourceUrl String?          @map("resource_url")
  progress    LessonProgress[]
  module      Module           @relation(fields: [moduleId], references: [id], onDelete: Cascade)
  assignment  Assignment?
  quiz        Quiz?

  @@map("lessons")
}

model Enrollment {
  id             String           @id @default(uuid())
  userId         String           @map("user_id")
  courseId       String           @map("course_id")
  status         String           @default("active")
  progress       Int              @default(0)
  enrolledAt     DateTime         @default(now()) @map("enrolled_at")
  completedAt    DateTime?        @map("completed_at")
  course         Course           @relation(fields: [courseId], references: [id], onDelete: Cascade)
  user           User             @relation(fields: [userId], references: [id], onDelete: Cascade)
  lessonProgress LessonProgress[]

  @@unique([userId, courseId])
  @@map("enrollments")
}

model LessonProgress {
  id           String     @id @default(uuid())
  enrollmentId String     @map("enrollment_id")
  lessonId     String     @map("lesson_id")
  isCompleted  Boolean    @default(false) @map("is_completed")
  completedAt  DateTime?  @map("completed_at")
  lastWatched  Int        @default(0) @map("last_watched")
  enrollment   Enrollment @relation(fields: [enrollmentId], references: [id], onDelete: Cascade)
  lesson       Lesson     @relation(fields: [lessonId], references: [id], onDelete: Cascade)

  @@unique([enrollmentId, lessonId])
  @@map("lesson_progress")
}

model Quiz {
  id           String         @id @default(uuid())
  lessonId     String         @unique @map("lesson_id")
  title        String
  description  String?
  timeLimit    Int?           @map("time_limit")
  passingScore Int            @default(70) @map("passing_score")
  createdAt    DateTime       @default(now()) @map("created_at")
  updatedAt    DateTime       @updatedAt @map("updated_at")
  attempts     QuizAttempt[]
  questions    QuizQuestion[]
  lesson       Lesson         @relation(fields: [lessonId], references: [id], onDelete: Cascade)

  @@map("lms_quizzes")
}

model QuizQuestion {
  id        String   @id @default(uuid())
  quizId    String   @map("quiz_id")
  text      String
  type      String
  options   Json?
  points    Int      @default(1)
  order     Int      @default(0)
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")
  quiz      Quiz     @relation(fields: [quizId], references: [id], onDelete: Cascade)

  @@map("lms_quiz_questions")
}

model QuizAttempt {
  id          String    @id @default(uuid())
  quizId      String    @map("quiz_id")
  userId      String    @map("user_id")
  score       Int       @default(0)
  isPassed    Boolean   @default(false) @map("is_passed")
  answers     Json?
  startedAt   DateTime  @default(now()) @map("started_at")
  completedAt DateTime? @map("completed_at")
  quiz        Quiz      @relation(fields: [quizId], references: [id], onDelete: Cascade)
  user        User      @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("lms_quiz_attempts")
}

model Assignment {
  id          String                 @id @default(uuid())
  lessonId    String                 @unique @map("lesson_id")
  title       String
  description String
  dueDate     DateTime?              @map("due_date")
  createdAt   DateTime               @default(now()) @map("created_at")
  updatedAt   DateTime               @updatedAt @map("updated_at")
  submissions AssignmentSubmission[]
  lesson      Lesson                 @relation(fields: [lessonId], references: [id], onDelete: Cascade)

  @@map("lms_assignments")
}

model AssignmentSubmission {
  id           String     @id @default(uuid())
  assignmentId String     @map("assignment_id")
  userId       String     @map("user_id")
  fileUrl      String?    @map("file_url")
  content      String?
  grade        Int?
  feedback     String?
  status       String     @default("submitted")
  submittedAt  DateTime   @default(now()) @map("submitted_at")
  gradedAt     DateTime?  @map("graded_at")
  assignment   Assignment @relation(fields: [assignmentId], references: [id], onDelete: Cascade)
  user         User       @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("lms_assignment_submissions")
}

model Store {
  id             String    @id @default(uuid())
  userId         String    @unique @map("user_id")
  name           String
  slug           String    @unique
  description    String?
  logoUrl        String?   @map("logo_url")
  bannerUrl      String?   @map("banner_url")
  refundPolicy   String?   @map("refund_policy")
  shippingPolicy String?   @map("shipping_policy")
  rating         Decimal   @default(0) @db.Decimal(3, 2)
  totalSales     Int       @default(0) @map("total_sales")
  isActive       Boolean   @default(true) @map("is_active")
  createdAt      DateTime  @default(now()) @map("created_at")
  updatedAt      DateTime  @updatedAt @map("updated_at")
  orders         Order[]
  products       Product[]
  reviews        Review[]
  user           User      @relation(fields: [userId], references: [id])

  @@map("stores")
}

model Product {
  id          String  @id @default(uuid())
  storeId     String? @map("store_id") // Optional for migration, make required later
  title       String
  slug        String  @unique
  description String? @db.Text
  price       Decimal @default(0) @db.Decimal(15, 2)
  stock       Int     @default(0)
  weight      Int     @default(0) // in grams
  category    String? // Deprecated in favor of categoryId? Or keep for simple string
  categoryId  String? @map("category_id")

  status          String  @default("draft") // draft, active, suspended, rejected
  images          Json? // Array of strings
  externalLinks   Json?   @map("external_links") // { shopee: "url", tokopedia: "url" }
  rejectionReason String? @map("rejection_reason")

  // Legacy field to be migrated
  sellerId String? @map("seller_id")

  // Analytics
  viewCount Int     @default(0) @map("view_count")
  soldCount Int     @default(0) @map("sold_count")
  rating    Decimal @default(0) @db.Decimal(3, 2)

  isPublished Boolean   @default(false) @map("is_published")
  createdAt   DateTime  @default(now()) @map("created_at")
  updatedAt   DateTime  @updatedAt @map("updated_at")
  deletedAt   DateTime? @map("deleted_at") // Soft delete

  store           Store?                      @relation(fields: [storeId], references: [id])
  seller          User?                       @relation(fields: [sellerId], references: [id]) // Keep for backward compat during migration
  cartItems       CartItem[]
  channelProducts MarketplaceChannelProduct[]
  orderItems      OrderItem[]
  reviews         Review[]

  @@map("products")
}

model Cart {
  id        String     @id @default(uuid())
  userId    String     @unique @map("user_id")
  createdAt DateTime   @default(now()) @map("created_at")
  updatedAt DateTime   @updatedAt @map("updated_at")
  items     CartItem[]
  user      User       @relation(fields: [userId], references: [id])

  @@map("carts")
}

model CartItem {
  id        String @id @default(uuid())
  cartId    String @map("cart_id")
  productId String @map("product_id")
  quantity  Int    @default(1)

  cart    Cart    @relation(fields: [cartId], references: [id], onDelete: Cascade)
  product Product @relation(fields: [productId], references: [id])

  @@map("cart_items")
}

model Order {
  id      String  @id @default(uuid())
  userId  String  @map("user_id")
  storeId String? @map("store_id") // Optional for migration

  // Status
  status String @default("pending")
  // pending, awaiting_payment, paid, processing, shipped, completed, cancelled, refund_requested, refunded

  // Financials
  totalAmount    Decimal @map("total_amount") @db.Decimal(15, 2)
  shippingCost   Decimal @default(0) @map("shipping_cost") @db.Decimal(15, 2)
  platformFee    Decimal @default(0) @map("platform_fee") @db.Decimal(15, 2)
  discountAmount Decimal @default(0) @map("discount_amount") @db.Decimal(15, 2)

  paymentLink    String? @map("payment_link")
  paymentStatus  String  @default("unpaid") @map("payment_status") // unpaid, pending, paid, failed, expired, refunded
  paymentMethod  String? @map("payment_method")
  paymentToken   String? @map("payment_token") // Midtrans Snap Token or Core API Order ID ref
  paymentGateway String  @default("mock") @map("payment_gateway") // mock, midtrans, xendit
  paymentData    Json?   @map("payment_data") // Full response from Gateway (VA numbers, etc)

  // Shipping
  shippingAddress Json? // Snapshot of address
  courier         String?
  trackingNumber  String? @map("tracking_number")

  // Cancellation Information
  cancellationReason String?   @map("cancellation_reason")
  cancelledAt        DateTime? @map("cancelled_at")
  cancelledBy        String?   @map("cancelled_by") // buyer, seller, system

  expiryTime DateTime? @map("expiry_time")

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  user     User        @relation(fields: [userId], references: [id])
  store    Store?      @relation(fields: [storeId], references: [id])
  items    OrderItem[]
  payment  Payment?
  shipment Shipment?
  reviews  Review[]

  @@map("orders")
}

model OrderItem {
  id        String @id @default(uuid())
  orderId   String @map("order_id")
  productId String @map("product_id")

  quantity Int     @default(1)
  price    Decimal @db.Decimal(15, 2) // Price at purchase time
  name     String? // Product name snapshot

  order   Order   @relation(fields: [orderId], references: [id], onDelete: Cascade)
  product Product @relation(fields: [productId], references: [id])

  @@map("order_items")
}

model Payment {
  id         String    @id @default(uuid())
  orderId    String    @unique @map("order_id")
  method     String
  provider   String?
  externalId String?   @map("external_id")
  status     String
  amount     Decimal   @db.Decimal(15, 2)
  paymentUrl String?   @map("payment_url")
  paidAt     DateTime? @map("paid_at")
  createdAt  DateTime  @default(now()) @map("created_at")
  updatedAt  DateTime  @updatedAt @map("updated_at")
  order      Order     @relation(fields: [orderId], references: [id])

  @@map("payments")
}

model Shipment {
  id              String    @id @default(uuid())
  orderId         String    @unique @map("order_id")
  courier         String
  service         String
  trackingNumber  String?   @map("tracking_number")
  status          String
  currentLocation String?   @map("current_location")
  shippedAt       DateTime? @map("shipped_at")
  deliveredAt     DateTime? @map("delivered_at")
  order           Order     @relation(fields: [orderId], references: [id])

  @@map("shipments")
}

model Review {
  id        String   @id @default(uuid())
  userId    String   @map("user_id")
  storeId   String   @map("store_id")
  productId String   @map("product_id")
  orderId   String   @map("order_id")
  rating    Int
  comment   String?
  images    Json?
  createdAt DateTime @default(now()) @map("created_at")
  order     Order    @relation(fields: [orderId], references: [id])
  product   Product  @relation(fields: [productId], references: [id])
  store     Store    @relation(fields: [storeId], references: [id])
  user      User     @relation(fields: [userId], references: [id])

  @@map("reviews")
}

model MarketplaceChannelSync {
  id           String    @id @default(uuid())
  storeId      String    @map("store_id")
  channel      String
  accessToken  String    @map("access_token")
  refreshToken String?   @map("refresh_token")
  expiresAt    DateTime? @map("expires_at")
  shopId       String?   @map("shop_id")
  isActive     Boolean   @default(true) @map("is_active")
  lastSyncAt   DateTime? @map("last_sync_at")
  createdAt    DateTime  @default(now()) @map("created_at")
  updatedAt    DateTime  @updatedAt @map("updated_at")

  @@map("marketplace_channel_syncs")
}

model MarketplaceChannelProduct {
  id         String    @id @default(uuid())
  productId  String    @map("product_id")
  channel    String
  externalId String    @map("external_id")
  syncStatus String    @default("synced")
  lastSyncAt DateTime? @map("last_sync_at")
  product    Product   @relation(fields: [productId], references: [id], onDelete: Cascade)

  @@unique([productId, channel])
  @@map("marketplace_channel_products")
}

model FinancingPartner {
  id           String            @id @default(uuid())
  name         String
  slug         String            @unique
  provider     String
  type         String
  maxAmount    Decimal           @map("max_amount") @db.Decimal(15, 2)
  interestRate String            @map("interest_rate")
  term         String
  requirements Json
  features     Json
  description  String
  logoUrl      String?           @map("logo_url")
  isActive     Boolean           @default(true) @map("is_active")
  createdAt    DateTime          @default(now()) @map("created_at")
  updatedAt    DateTime          @updatedAt @map("updated_at")
  applications LoanApplication[]

  @@map("financing_partners")
}

model LoanApplication {
  id        String           @id @default(uuid())
  userId    String           @map("user_id")
  partnerId String           @map("partner_id")
  amount    Decimal          @db.Decimal(15, 2)
  term      Int
  purpose   String
  status    String           @default("submitted")
  notes     String?
  createdAt DateTime         @default(now()) @map("created_at")
  updatedAt DateTime         @updatedAt @map("updated_at")
  partner   FinancingPartner @relation(fields: [partnerId], references: [id])
  user      User             @relation(fields: [userId], references: [id], onDelete: Cascade)
  documents LoanDocument[]

  @@map("loan_applications")
}

model LoanDocument {
  id            String          @id @default(uuid())
  applicationId String          @map("application_id")
  type          String
  fileUrl       String          @map("file_url")
  fileName      String          @map("file_name")
  fileSize      Int?            @map("file_size")
  mimeType      String?         @map("mime_type")
  status        String          @default("pending")
  createdAt     DateTime        @default(now()) @map("created_at")
  updatedAt     DateTime        @updatedAt @map("updated_at")
  application   LoanApplication @relation(fields: [applicationId], references: [id], onDelete: Cascade)

  @@map("loan_documents")
}

model ExportHSCode {
  id           String   @id @default(uuid())
  code         String   @unique
  description  String
  tariff       String?
  requirements Json?
  category     String?
  createdAt    DateTime @default(now()) @map("created_at")
  updatedAt    DateTime @updatedAt @map("updated_at")

  @@map("export_hs_codes")
}

model ExportCountry {
  id           String        @id @default(uuid())
  name         String        @unique
  code         String        @unique
  flag         String?
  market       String?
  distance     String?
  shippingTime String?       @map("shipping_time")
  avgTariff    String?       @map("avg_tariff")
  requirements Json?
  topProducts  Json?
  createdAt    DateTime      @default(now()) @map("created_at")
  updatedAt    DateTime      @updatedAt @map("updated_at")
  buyers       ExportBuyer[]

  @@map("export_countries")
}

model ExportBuyer {
  id          String        @id @default(uuid())
  companyName String        @map("company_name")
  countryId   String        @map("country_id")
  category    String?
  products    Json?
  volume      String?
  isVerified  Boolean       @default(false) @map("is_verified")
  rating      Decimal       @default(0) @db.Decimal(3, 2)
  contactInfo Json?         @map("contact_info")
  createdAt   DateTime      @default(now()) @map("created_at")
  updatedAt   DateTime      @updatedAt @map("updated_at")
  country     ExportCountry @relation(fields: [countryId], references: [id])

  @@map("export_buyers")
}

model ForumCategory {
  id          String        @id @default(uuid())
  name        String
  description String?
  slug        String        @unique
  icon        String?
  order       Int           @default(0)
  createdAt   DateTime      @default(now()) @map("created_at")
  updatedAt   DateTime      @updatedAt @map("updated_at")
  threads     ForumThread[]

  @@map("forum_categories")
}

model ForumThread {
  id         String        @id @default(uuid())
  title      String
  content    String
  authorId   String        @map("author_id")
  categoryId String        @map("category_id")
  views      Int           @default(0)
  isPinned   Boolean       @default(false) @map("is_pinned")
  isLocked   Boolean       @default(false) @map("is_locked")
  createdAt  DateTime      @default(now()) @map("created_at")
  updatedAt  DateTime      @updatedAt @map("updated_at")
  posts      ForumPost[]
  author     User          @relation(fields: [authorId], references: [id])
  category   ForumCategory @relation(fields: [categoryId], references: [id])
  upvotes    ForumUpvote[]

  @@map("forum_threads")
}

model ForumPost {
  id        String        @id @default(uuid())
  content   String
  threadId  String        @map("thread_id")
  authorId  String        @map("author_id")
  parentId  String?       @map("parent_id")
  createdAt DateTime      @default(now()) @map("created_at")
  updatedAt DateTime      @updatedAt @map("updated_at")
  author    User          @relation(fields: [authorId], references: [id])
  parent    ForumPost?    @relation("PostReplies", fields: [parentId], references: [id])
  replies   ForumPost[]   @relation("PostReplies")
  thread    ForumThread   @relation(fields: [threadId], references: [id], onDelete: Cascade)
  upvotes   ForumUpvote[]

  @@map("forum_posts")
}

model ForumUpvote {
  id        String       @id @default(uuid())
  userId    String       @map("user_id")
  threadId  String?      @map("thread_id")
  postId    String?      @map("post_id")
  createdAt DateTime     @default(now()) @map("created_at")
  post      ForumPost?   @relation(fields: [postId], references: [id], onDelete: Cascade)
  thread    ForumThread? @relation(fields: [threadId], references: [id], onDelete: Cascade)
  user      User         @relation(fields: [userId], references: [id])

  @@unique([userId, threadId, postId])
  @@map("forum_upvotes")
}

model Event {
  id              String              @id @default(uuid())
  title           String
  description     String
  bannerUrl       String?             @map("banner_url")
  startDate       DateTime            @map("start_date")
  endDate         DateTime            @map("end_date")
  location        String
  type            String
  maxParticipants Int?                @map("max_participants")
  organizerId     String              @map("organizer_id")
  createdAt       DateTime            @default(now()) @map("created_at")
  updatedAt       DateTime            @updatedAt @map("updated_at")
  registrations   EventRegistration[]
  organizer       User                @relation(fields: [organizerId], references: [id])

  @@map("events")
}

model EventRegistration {
  id           String   @id @default(uuid())
  eventId      String   @map("event_id")
  userId       String   @map("user_id")
  status       String   @default("registered")
  registeredAt DateTime @default(now()) @map("registered_at")
  event        Event    @relation(fields: [eventId], references: [id], onDelete: Cascade)
  user         User     @relation(fields: [userId], references: [id])

  @@unique([eventId, userId])
  @@map("event_registrations")
}

model Program {
  id          String             @id @default(uuid())
  title       String
  description String
  type        String
  status      String             @default("draft")
  bannerUrl   String?            @map("banner_url")
  startDate   DateTime           @map("start_date")
  endDate     DateTime           @map("end_date")
  organizerId String             @map("organizer_id")
  createdAt   DateTime           @default(now()) @map("created_at")
  updatedAt   DateTime           @updatedAt @map("updated_at")
  batches     ProgramBatch[]
  milestones  ProgramMilestone[]
  organizer   User               @relation(fields: [organizerId], references: [id])

  @@map("programs")
}

model ProgramBatch {
  id              String               @id @default(uuid())
  programId       String               @map("program_id")
  name            String
  startDate       DateTime             @map("start_date")
  endDate         DateTime             @map("end_date")
  maxParticipants Int                  @map("max_participants")
  createdAt       DateTime             @default(now()) @map("created_at")
  updatedAt       DateTime             @updatedAt @map("updated_at")
  program         Program              @relation(fields: [programId], references: [id], onDelete: Cascade)
  participants    ProgramParticipant[]

  @@map("program_batches")
}

model ProgramParticipant {
  id       String       @id @default(uuid())
  batchId  String       @map("batch_id")
  userId   String       @map("user_id")
  status   String       @default("applied")
  joinedAt DateTime     @default(now()) @map("joined_at")
  notes    String?
  batch    ProgramBatch @relation(fields: [batchId], references: [id], onDelete: Cascade)
  user     User         @relation(fields: [userId], references: [id])

  @@unique([batchId, userId])
  @@map("program_participants")
}

model ProgramMilestone {
  id          String   @id @default(uuid())
  programId   String   @map("program_id")
  title       String
  description String?
  order       Int      @default(0)
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")
  program     Program  @relation(fields: [programId], references: [id], onDelete: Cascade)

  @@map("program_milestones")
}

model ConsultantProfile {
  id                    String                   @id @default(uuid())
  userId                String                   @unique @map("user_id")
  title                 String
  tagline               String?
  bio                   String
  videoIntroUrl         String?                  @map("video_intro_url")
  expertiseAreas        String[]                 @map("expertise_areas")
  industries            String[]                 @default([])
  languages             String[]                 @default(["Indonesian"])
  yearsExperience       Int                      @map("years_experience")
  certifications        String?
  education             String?
  hourlyRate            Int                      @map("hourly_rate")
  isAcceptingNewClients Boolean                  @default(true) @map("is_accepting_new_clients")
  cancellationPolicy    String?                  @map("cancellation_policy")
  status                String                   @default("pending")
  verificationStatus    String                   @default("unverified") @map("verification_status")
  isFeatured            Boolean                  @default(false) @map("is_featured")
  totalSessions         Int                      @default(0) @map("total_sessions")
  averageRating         Float                    @default(0) @map("average_rating")
  createdAt             DateTime                 @default(now()) @map("created_at")
  updatedAt             DateTime                 @updatedAt @map("updated_at")
  canTeachCourses       Boolean                  @default(false) @map("can_teach_courses")
  consultationTypeId    String?                  @map("consultation_type_id")
  instructorBio         String?                  @map("instructor_bio")
  totalCoursesCreated   Int                      @default(0) @map("total_courses_created")
  totalEarnings         Float                    @default(0) @map("total_earnings")
  totalStudents         Int                      @default(0) @map("total_students")
  availability          ConsultantAvailability[]
  consultationType      ConsultationType?        @relation(fields: [consultationTypeId], references: [id])
  user                  User                     @relation(fields: [userId], references: [id], onDelete: Cascade)
  consultationRequests  ConsultationRequest[]
  reviews               ConsultationReview[]
  courses               Course[]                 @relation("InstructorCourses")
  expertise             ConsultantExpertise[]
  packages              ConsultationPackage[]

  @@map("consultant_profiles")
}

model ConsultationPackage {
  id              String   @id @default(uuid())
  consultantId    String   @map("consultant_id")
  name            String
  durationMinutes Int      @map("duration_minutes")
  price           Int // Price in IDR
  description     String?
  isActive        Boolean  @default(true) @map("is_active")
  sortOrder       Int      @default(0) @map("sort_order")
  createdAt       DateTime @default(now()) @map("created_at")
  updatedAt       DateTime @updatedAt @map("updated_at")

  consultant ConsultantProfile     @relation(fields: [consultantId], references: [id], onDelete: Cascade)
  requests   ConsultationRequest[]

  @@map("consultation_packages")
}

model ConsultantAvailability {
  id           String            @id @default(uuid())
  consultantId String            @map("consultant_id")
  dayOfWeek    Int?              @map("day_of_week")
  startTime    DateTime          @map("start_time") @db.Time(6)
  endTime      DateTime          @map("end_time") @db.Time(6)
  isRecurring  Boolean           @default(true) @map("is_recurring")
  specificDate DateTime?         @map("specific_date") @db.Date
  isAvailable  Boolean           @default(true) @map("is_available")
  timezone     String            @default("Asia/Jakarta")
  createdAt    DateTime          @default(now()) @map("created_at")
  updatedAt    DateTime          @updatedAt @map("updated_at")
  consultant   ConsultantProfile @relation(fields: [consultantId], references: [id], onDelete: Cascade)

  @@map("consultant_availability")
}

model ConsultationType {
  id                String                @id @default(uuid())
  name              String                @unique
  slug              String                @unique
  description       String?
  iconUrl           String?               @map("icon_url")
  category          String?
  tags              String[]
  basePrice         Decimal               @default(0) @map("base_price") @db.Decimal(10, 2)
  duration          Int                   @default(60)
  isPremium         Boolean               @default(false) @map("is_premium")
  isActive          Boolean               @default(true) @map("is_active")
  requiresPrep      Boolean               @default(false) @map("requires_prep")
  createdAt         DateTime              @default(now()) @map("created_at")
  updatedAt         DateTime              @updatedAt @map("updated_at")
  ConsultantProfile ConsultantProfile[]
  requests          ConsultationRequest[]

  @@map("consultation_types")
}

model ConsultationRequest {
  id                 String               @id @default(uuid())
  clientId           String               @map("client_id")
  consultantId       String               @map("consultant_id")
  typeId             String?              @map("type_id")
  requestedDate      DateTime             @map("requested_date") @db.Date
  requestedStartTime DateTime             @map("requested_start_time") @db.Time(6)
  requestedEndTime   DateTime             @map("requested_end_time") @db.Time(6)
  durationMinutes    Int                  @map("duration_minutes")
  timezone           String               @default("Asia/Jakarta")
  topic              String
  description        String?
  status             String               @default("pending")
  statusReason       String?              @map("status_reason")
  meetingUrl         String?              @map("meeting_url")
  meetingPlatform    String?              @map("meeting_platform")
  createdAt          DateTime             @default(now()) @map("created_at")
  updatedAt          DateTime             @updatedAt @map("updated_at")
  isPaid             Boolean              @default(false) @map("is_paid")
  quotedPrice        Decimal              @default(0) @map("quoted_price") @db.Decimal(10, 2)
  sessionNotes       String?              @map("session_notes")
  isArchived         Boolean              @default(false) @map("is_archived")
  archivedAt         DateTime?            @map("archived_at")
  chatChannel        ChatChannel?
  packageId          String?              @map("package_id")
  client             User                 @relation(fields: [clientId], references: [id])
  consultant         ConsultantProfile    @relation(fields: [consultantId], references: [id])
  type               ConsultationType?    @relation(fields: [typeId], references: [id])
  package            ConsultationPackage? @relation(fields: [packageId], references: [id])
  sessionFiles       SessionFile[]

  @@map("consultation_requests")
}

model ChatChannel {
  id        String              @id @default(uuid())
  requestId String              @unique @map("request_id")
  isActive  Boolean             @default(true) @map("is_active")
  createdAt DateTime            @default(now()) @map("created_at")
  updatedAt DateTime            @updatedAt @map("updated_at")
  request   ConsultationRequest @relation(fields: [requestId], references: [id], onDelete: Cascade)
  messages  ChatMessage[]

  @@map("chat_channels")
}

model ChatMessage {
  id          String      @id @default(uuid())
  channelId   String      @map("channel_id")
  senderId    String      @map("sender_id")
  content     String?
  contentType String      @default("text") @map("content_type")
  fileUrl     String?     @map("file_url")
  isRead      Boolean     @default(false) @map("is_read")
  readAt      DateTime?   @map("read_at")
  createdAt   DateTime    @default(now()) @map("created_at")
  channel     ChatChannel @relation(fields: [channelId], references: [id], onDelete: Cascade)
  sender      User        @relation(fields: [senderId], references: [id])

  @@map("chat_messages")
}

model SessionFile {
  id          String              @id @default(uuid())
  requestId   String              @map("request_id")
  uploadedBy  String              @map("uploaded_by")
  fileName    String              @map("file_name")
  fileUrl     String              @map("file_url")
  fileSize    Int?                @map("file_size")
  mimeType    String?             @map("mime_type")
  description String?
  createdAt   DateTime            @default(now()) @map("created_at")
  request     ConsultationRequest @relation(fields: [requestId], references: [id], onDelete: Cascade)
  uploader    User                @relation(fields: [uploadedBy], references: [id])

  @@map("session_files")
}

model ConsultationReview {
  id           String            @id @default(uuid())
  consultantId String            @map("consultant_id")
  clientId     String            @map("client_id")
  rating       Int
  comment      String?
  isPublished  Boolean           @default(true) @map("is_published")
  createdAt    DateTime          @default(now()) @map("created_at")
  client       User              @relation(fields: [clientId], references: [id])
  consultant   ConsultantProfile @relation(fields: [consultantId], references: [id])

  @@map("consultation_reviews")
}

model ExpertiseCategory {
  id            String                @id @default(uuid())
  name          String                @unique
  slug          String                @unique
  description   String?
  icon          String                @default("Briefcase")
  categoryGroup String?               @map("category_group")
  isActive      Boolean               @default(true) @map("is_active")
  isDeleted     Boolean               @default(false) @map("is_deleted")
  deletedAt     DateTime?             @map("deleted_at")
  createdBy     String?               @map("created_by")
  createdAt     DateTime              @default(now()) @map("created_at")
  updatedAt     DateTime              @updatedAt @map("updated_at")
  consultants   ConsultantExpertise[]
  auditLogs     ExpertiseAuditLog[]
  creator       User?                 @relation(fields: [createdBy], references: [id], onDelete: SetNull)

  @@index([isActive, isDeleted])
  @@index([slug])
  @@map("expertise_categories")
}

model ConsultantExpertise {
  id           String            @id @default(uuid())
  consultantId String            @map("consultant_id")
  expertiseId  String            @map("expertise_id")
  createdAt    DateTime          @default(now()) @map("created_at")
  consultant   ConsultantProfile @relation(fields: [consultantId], references: [id], onDelete: Cascade)
  expertise    ExpertiseCategory @relation(fields: [expertiseId], references: [id], onDelete: Restrict)

  @@unique([consultantId, expertiseId])
  @@index([consultantId])
  @@index([expertiseId])
  @@map("consultant_expertise")
}

model ExpertiseAuditLog {
  id          String             @id @default(uuid())
  expertiseId String?            @map("expertise_id")
  action      String
  oldValue    Json?              @map("old_value")
  newValue    Json?              @map("new_value")
  changedBy   String?            @map("changed_by")
  changedAt   DateTime           @default(now()) @map("changed_at")
  expertise   ExpertiseCategory? @relation(fields: [expertiseId], references: [id], onDelete: SetNull)
  user        User?              @relation(fields: [changedBy], references: [id], onDelete: SetNull)

  @@index([expertiseId])
  @@index([changedBy])
  @@map("expertise_audit_logs")
}

// ============================================
// ARSIPARI - MAIL & ARCHIVE MANAGEMENT SYSTEM
// ============================================

// Letter category for classification
model LetterCategory {
  id          String   @id @default(uuid())
  code        String   @unique // Category code (e.g., SK, SURAT, UNDANGAN)
  name        String // Category name
  description String?
  isActive    Boolean  @default(true) @map("is_active")
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")

  // Relations
  incomingLetters IncomingLetter[]
  outgoingLetters OutgoingLetter[]
  archives        Archive[]

  @@index([isActive])
  @@map("letter_categories")
}

// Letter Subject / Perihal Surat for Numbering
model LetterSubject {
  id          String   @id @default(uuid())
  code        String   @unique // Classification code (e.g., 005, UM)
  name        String // Subject name (e.g., Undangan, Umum)
  description String?
  isActive    Boolean  @default(true) @map("is_active")
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")

  // Relations
  outgoingLetters OutgoingLetter[]

  @@index([isActive])
  @@map("letter_subjects")
}

// Letterhead / Kop surat
model Letterhead {
  id        String   @id @default(uuid())
  name      String // Institution/unit name
  unit      String? // Unit/organization name
  address   String?  @db.Text
  website   String?
  email     String?
  phone     String?
  logoUrl   String?  @map("logo_url")
  config    Json? // Custom layout configuration
  isActive  Boolean  @default(true) @map("is_active")
  isDefault Boolean  @default(false) @map("is_default")
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  // Relations
  templates LetterTemplate[]

  @@index([isActive])
  @@map("letterheads")
}

// Letter template for outgoing letters
model LetterTemplate {
  id           String   @id @default(uuid())
  name         String // Template name
  code         String   @unique // Template code
  type         String // Letter type (UNDANGAN, EDARAN, SURAT_PERINTAH, etc)
  description  String?
  letterheadId String?  @map("letterhead_id")
  content      String   @db.Text // Template content with variable placeholders
  variables    String[] // Variable names: ["nomor", "tanggal", "tujuan", "perihal", "isi"]
  numberFormat String?  @map("number_format") // Number format, e.g., "NO/UNIT/BULAN/TAHUN"
  isActive     Boolean  @default(true) @map("is_active")
  createdAt    DateTime @default(now()) @map("created_at")
  updatedAt    DateTime @updatedAt @map("updated_at")

  // Relations
  letterhead      Letterhead?      @relation(fields: [letterheadId], references: [id])
  outgoingLetters OutgoingLetter[]

  @@index([isActive])
  @@map("letter_templates")
}

// Incoming letter / Surat masuk
model IncomingLetter {
  id             String    @id @default(uuid())
  letterNumber   String    @map("letter_number") // Letter number from sender
  letterDate     DateTime  @map("letter_date") // Letter date
  receivedDate   DateTime  @map("received_date") // Received date
  sender         String // Sender name
  senderAddress  String?   @map("sender_address")
  subject        String // Subject
  categoryId     String?   @map("category_id")
  classification String? // Security classification: BIASA, RAHASIA, SANGAT_RAHASIA
  nature         String? // Letter nature: BIASA, PENTING, SEGERA
  priority       String    @default("NORMAL") // RENDAH, NORMAL, TINGGI, URGENT
  fileUrl        String?   @map("file_url") // File URL (PDF/IMG)
  fileName       String?   @map("file_name")
  fileSize       Int?      @map("file_size")
  mimeType       String?   @map("mime_type")
  status         String    @default("BARU") // BARU, DIPROSES, DISPOSISI, SELESAI, ARSIP
  notes          String?   @db.Text
  createdBy      String?   @map("created_by")
  createdAt      DateTime  @default(now()) @map("created_at")
  updatedAt      DateTime  @updatedAt @map("updated_at")
  finishedAt     DateTime? @map("finished_at")
  archivedAt     DateTime? @map("archived_at")

  // Relations
  category     LetterCategory? @relation(fields: [categoryId], references: [id])
  creator      User?           @relation("IncomingLetterCreator", fields: [createdBy], references: [id])
  dispositions Disposition[]
  archive      Archive?

  @@unique([letterNumber])
  @@index([status])
  @@index([letterDate])
  @@index([priority])
  @@index([categoryId])
  @@index([createdBy])
  @@map("incoming_letters")
}

// Outgoing letter / Surat keluar
model OutgoingLetter {
  id               String    @id @default(uuid())
  letterNumber     String?   @map("letter_number") // Auto-generated on publish
  templateId       String?   @map("template_id")
  recipient        String // Recipient
  recipientAddress String?   @map("recipient_address")
  subject          String // Subject
  content          String    @db.Text // Letter content
  attachment       String?
  letterDate       DateTime? @map("letter_date") // Letter date
  categoryId       String?   @map("category_id")
  subjectId        String?   @map("subject_id")
  classification   String? // Security classification: BIASA, RAHASIA, SANGAT_RAHASIA
  nature           String? // Letter nature: BIASA, PENTING, SEGERA
  priority         String    @default("NORMAL") // RENDAH, NORMAL, TINGGI, URGENT
  status           String    @default("DRAFT") // DRAFT, REVIEW, APPROVED, REJECTED, PUBLISHED, ARSIP
  fileUrl          String?   @map("file_url") // Generated PDF
  fileName         String?   @map("file_name")
  fileSize         Int?      @map("file_size")
  mimeType         String?   @map("mime_type")
  revision         Int       @default(0)
  notes            String?   @db.Text
  createdBy        String?   @map("created_by")
  createdAt        DateTime  @default(now()) @map("created_at")
  updatedAt        DateTime  @updatedAt @map("updated_at")
  publishedAt      DateTime? @map("published_at")
  archivedAt       DateTime? @map("archived_at")

  // Relations
  template      LetterTemplate?  @relation(fields: [templateId], references: [id])
  category      LetterCategory?  @relation(fields: [categoryId], references: [id])
  letterSubject LetterSubject?   @relation(fields: [subjectId], references: [id])
  creator       User?            @relation("OutgoingLetterCreator", fields: [createdBy], references: [id])
  approvals     LetterApproval[]
  archive       Archive?

  @@unique([letterNumber])
  @@index([status])
  @@index([categoryId])
  @@index([createdBy])
  @@map("outgoing_letters")
}

// Letter disposition / Disposisi
model Disposition {
  id               String    @id @default(uuid())
  incomingLetterId String    @map("incoming_letter_id")
  fromUserId       String    @map("from_user_id")
  toUserId         String    @map("to_user_id")
  instruction      String    @db.Text
  notes            String?   @db.Text
  status           String    @default("AWAITING") // AWAITING, READ, COMPLETED
  readAt           DateTime? @map("read_at")
  completedAt      DateTime? @map("completed_at")
  createdAt        DateTime  @default(now()) @map("created_at")
  updatedAt        DateTime  @updatedAt @map("updated_at")

  // Relations
  incomingLetter IncomingLetter @relation(fields: [incomingLetterId], references: [id], onDelete: Cascade)
  fromUser       User           @relation("DispositionFrom", fields: [fromUserId], references: [id])
  toUser         User           @relation("DispositionTo", fields: [toUserId], references: [id])

  @@index([incomingLetterId])
  @@index([fromUserId])
  @@index([toUserId])
  @@index([status])
  @@map("dispositions")
}

// Letter approval workflow
model LetterApproval {
  id               String    @id @default(uuid())
  outgoingLetterId String    @map("outgoing_letter_id")
  userId           String    @map("user_id")
  sequence         Int // Approval sequence order
  status           String    @default("PENDING") // PENDING, APPROVED, REJECTED
  notes            String?   @db.Text
  approvalDate     DateTime? @map("approval_date")
  createdAt        DateTime  @default(now()) @map("created_at")
  updatedAt        DateTime  @updatedAt @map("updated_at")

  // Relations
  outgoingLetter OutgoingLetter @relation(fields: [outgoingLetterId], references: [id], onDelete: Cascade)
  user           User           @relation("LetterApprovalUser", fields: [userId], references: [id])

  @@index([outgoingLetterId])
  @@index([userId])
  @@index([status])
  @@map("letter_approvals")
}

// Central archive
model Archive {
  id                String    @id @default(uuid())
  archiveNumber     String    @unique @map("archive_number") // Unique archive number
  letterType        String    @map("letter_type") // MASUK, KELUAR
  incomingLetterId  String?   @unique @map("incoming_letter_id")
  outgoingLetterId  String?   @unique @map("outgoing_letter_id")
  letterNumber      String    @map("letter_number")
  subject           String
  categoryId        String?   @map("category_id")
  archiveYear       Int       @map("archive_year")
  archiveMonth      Int       @map("archive_month")
  location          String? // Physical location: Cabinet, Shelf, Box
  protectionLevel   String?   @map("protection_level") // OPEN, RESTRICTED, SECRET
  activeRetention   Int?      @map("active_retention") // Years in active retention
  inactiveRetention Int?      @map("inactive_retention") // Years in inactive retention
  disposalDate      DateTime? @map("disposal_date") // Date when can be destroyed
  status            String    @default("AKTIF") // AKTIF, INAKTIF, MUSNAH
  notes             String?   @db.Text
  createdBy         String?   @map("created_by")
  createdAt         DateTime  @default(now()) @map("created_at")
  updatedAt         DateTime  @updatedAt @map("updated_at")
  deletedAt         DateTime? @map("deleted_at")

  // Relations
  incomingLetter IncomingLetter? @relation(fields: [incomingLetterId], references: [id])
  outgoingLetter OutgoingLetter? @relation(fields: [outgoingLetterId], references: [id])
  category       LetterCategory? @relation(fields: [categoryId], references: [id])
  creator        User?           @relation("ArchiveCreator", fields: [createdBy], references: [id])

  @@index([letterType])
  @@index([categoryId])
  @@index([archiveYear])
  @@index([archiveMonth])
  @@index([status])
  @@map("archives")
}
